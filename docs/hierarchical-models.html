<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 5 Hierarchical Models | Bayesian Data Analysis</title>
  <meta name="description" content="Chapter 5 Hierarchical Models | Bayesian Data Analysis review by Andrew Gelman, supervised by Dr. Paul Marjoram" />
  <meta name="generator" content="bookdown 0.28 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 5 Hierarchical Models | Bayesian Data Analysis" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Chapter 5 Hierarchical Models | Bayesian Data Analysis review by Andrew Gelman, supervised by Dr. Paul Marjoram" />
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 5 Hierarchical Models | Bayesian Data Analysis" />
  
  <meta name="twitter:description" content="Chapter 5 Hierarchical Models | Bayesian Data Analysis review by Andrew Gelman, supervised by Dr. Paul Marjoram" />
  

<meta name="author" content="Anthony R. Colombo, Dr. Paul Marjoram" />


<meta name="date" content="2022-09-11" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="asymptotics-and-connections-to-non-bayesian-approaches.html"/>
<link rel="next" href="sharing-your-book.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Bayesian Data Analysis</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>About</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#independent-study"><i class="fa fa-check"></i>Independent study</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#supervised-learning"><i class="fa fa-check"></i>Supervised learning</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="fundamentals-of-bayesian-inference.html"><a href="fundamentals-of-bayesian-inference.html"><i class="fa fa-check"></i><b>1</b> Fundamentals of Bayesian Inference</a>
<ul>
<li class="chapter" data-level="1.1" data-path="fundamentals-of-bayesian-inference.html"><a href="fundamentals-of-bayesian-inference.html#general-notation-for-statistical-inference"><i class="fa fa-check"></i><b>1.1</b> General notation for statistical inference</a>
<ul>
<li class="chapter" data-level="" data-path="fundamentals-of-bayesian-inference.html"><a href="fundamentals-of-bayesian-inference.html#exchangeability"><i class="fa fa-check"></i>Exchangeability</a></li>
<li class="chapter" data-level="" data-path="fundamentals-of-bayesian-inference.html"><a href="fundamentals-of-bayesian-inference.html#explanatory-variables"><i class="fa fa-check"></i>Explanatory variables</a></li>
<li class="chapter" data-level="" data-path="fundamentals-of-bayesian-inference.html"><a href="fundamentals-of-bayesian-inference.html#hierarchical-modeling"><i class="fa fa-check"></i>Hierarchical modeling</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="fundamentals-of-bayesian-inference.html"><a href="fundamentals-of-bayesian-inference.html#bayesian-inference"><i class="fa fa-check"></i><b>1.2</b> Bayesian inference</a></li>
<li class="chapter" data-level="" data-path="fundamentals-of-bayesian-inference.html"><a href="fundamentals-of-bayesian-inference.html#prediction"><i class="fa fa-check"></i>Prediction</a></li>
<li class="chapter" data-level="" data-path="fundamentals-of-bayesian-inference.html"><a href="fundamentals-of-bayesian-inference.html#likelihood"><i class="fa fa-check"></i>Likelihood</a></li>
<li class="chapter" data-level="" data-path="fundamentals-of-bayesian-inference.html"><a href="fundamentals-of-bayesian-inference.html#subjectivity-and-objectivity"><i class="fa fa-check"></i>Subjectivity and Objectivity</a></li>
<li class="chapter" data-level="1.3" data-path="fundamentals-of-bayesian-inference.html"><a href="fundamentals-of-bayesian-inference.html#exercises"><i class="fa fa-check"></i><b>1.3</b> Exercises</a></li>
<li class="chapter" data-level="" data-path="fundamentals-of-bayesian-inference.html"><a href="fundamentals-of-bayesian-inference.html#simulation-100-times"><i class="fa fa-check"></i>Simulation 100 times</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="cross.html"><a href="cross.html"><i class="fa fa-check"></i><b>2</b> Single parameter models</a>
<ul>
<li class="chapter" data-level="2.1" data-path="cross.html"><a href="cross.html#estimating-a-probability-from-binomial-data"><i class="fa fa-check"></i><b>2.1</b> Estimating a probability from binomial data</a></li>
<li class="chapter" data-level="2.2" data-path="cross.html"><a href="cross.html#posterior-as-a-compromise-between-data-and-prior-information"><i class="fa fa-check"></i><b>2.2</b> Posterior as a compromise between data and prior information</a></li>
<li class="chapter" data-level="2.3" data-path="cross.html"><a href="cross.html#summarizing-the-posterior-inference"><i class="fa fa-check"></i><b>2.3</b> Summarizing the posterior inference</a>
<ul>
<li class="chapter" data-level="" data-path="cross.html"><a href="cross.html#posterior-quantiles-and-intervals"><i class="fa fa-check"></i>Posterior quantiles and intervals</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="cross.html"><a href="cross.html#informative-prior-distributions"><i class="fa fa-check"></i><b>2.4</b> Informative prior distributions</a>
<ul>
<li class="chapter" data-level="" data-path="cross.html"><a href="cross.html#conjugate-prior-distributions"><i class="fa fa-check"></i>Conjugate prior distributions</a></li>
<li class="chapter" data-level="" data-path="cross.html"><a href="cross.html#conjugate-prior-distributions-exponential-families-and-sufficient-statistics"><i class="fa fa-check"></i>Conjugate prior, distributions, exponential families, and sufficient statistics</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="cross.html"><a href="cross.html#normal-distribution-with-known-variance"><i class="fa fa-check"></i><b>2.5</b> Normal distribution with known variance</a>
<ul>
<li class="chapter" data-level="" data-path="cross.html"><a href="cross.html#likelihood-of-one-data-point"><i class="fa fa-check"></i>Likelihood of one data point</a></li>
<li class="chapter" data-level="2.5.1" data-path="cross.html"><a href="cross.html#conjugate-prior-and-posterior-distributions"><i class="fa fa-check"></i><b>2.5.1</b> Conjugate prior and posterior distributions</a></li>
<li class="chapter" data-level="" data-path="cross.html"><a href="cross.html#posterior-predictive-distribution"><i class="fa fa-check"></i>Posterior predictive distribution</a></li>
<li class="chapter" data-level="" data-path="cross.html"><a href="cross.html#normal-model-with-multiple-observations"><i class="fa fa-check"></i>Normal model with multiple observations</a></li>
</ul></li>
<li class="chapter" data-level="2.6" data-path="cross.html"><a href="cross.html#other-standard-single-parameter-models"><i class="fa fa-check"></i><b>2.6</b> Other standard single-parameter models</a>
<ul>
<li class="chapter" data-level="" data-path="cross.html"><a href="cross.html#normal-distribution-with-known-mean-but-unknown-variance"><i class="fa fa-check"></i>Normal distribution with known mean but unknown variance</a></li>
<li class="chapter" data-level="" data-path="cross.html"><a href="cross.html#poisson-model"><i class="fa fa-check"></i>Poisson model</a></li>
<li class="chapter" data-level="" data-path="cross.html"><a href="cross.html#negative-binomial-distribution"><i class="fa fa-check"></i>Negative Binomial distribution</a></li>
<li class="chapter" data-level="" data-path="cross.html"><a href="cross.html#exponential-distribution"><i class="fa fa-check"></i>Exponential distribution</a></li>
<li class="chapter" data-level="" data-path="cross.html"><a href="cross.html#constructing-a-prior-distribution"><i class="fa fa-check"></i>Constructing a prior distribution</a></li>
</ul></li>
<li class="chapter" data-level="2.7" data-path="cross.html"><a href="cross.html#noninformative-prior-distributions"><i class="fa fa-check"></i><b>2.7</b> Noninformative prior distributions</a>
<ul>
<li class="chapter" data-level="2.7.1" data-path="cross.html"><a href="cross.html#jeffreys-invariance-principle"><i class="fa fa-check"></i><b>2.7.1</b> Jeffreys’ invariance principle</a></li>
<li class="chapter" data-level="" data-path="cross.html"><a href="cross.html#difficulties-with-noninformative-prior-distributions"><i class="fa fa-check"></i>Difficulties with noninformative prior distributions</a></li>
</ul></li>
<li class="chapter" data-level="2.8" data-path="cross.html"><a href="cross.html#exercises-1"><i class="fa fa-check"></i><b>2.8</b> Exercises</a>
<ul>
<li class="chapter" data-level="" data-path="cross.html"><a href="cross.html#question-1"><i class="fa fa-check"></i>Question 1</a></li>
<li class="chapter" data-level="" data-path="cross.html"><a href="cross.html#normal-approximation-example"><i class="fa fa-check"></i>Normal approximation example</a></li>
<li class="chapter" data-level="" data-path="cross.html"><a href="cross.html#question-3"><i class="fa fa-check"></i>Question 3</a></li>
<li class="chapter" data-level="" data-path="cross.html"><a href="cross.html#question-4"><i class="fa fa-check"></i>Question 4</a></li>
<li class="chapter" data-level="" data-path="cross.html"><a href="cross.html#question-7"><i class="fa fa-check"></i>Question 7</a></li>
<li class="chapter" data-level="" data-path="cross.html"><a href="cross.html#question-8-normal-distribution-with-unknown-mean"><i class="fa fa-check"></i>Question 8 (Normal distribution with unknown mean)</a></li>
<li class="chapter" data-level="" data-path="cross.html"><a href="cross.html#question-10"><i class="fa fa-check"></i>Question 10</a></li>
<li class="chapter" data-level="" data-path="cross.html"><a href="cross.html#question-11"><i class="fa fa-check"></i>Question 11</a></li>
<li class="chapter" data-level="" data-path="cross.html"><a href="cross.html#question-12"><i class="fa fa-check"></i>Question 12</a></li>
<li class="chapter" data-level="" data-path="cross.html"><a href="cross.html#question-13"><i class="fa fa-check"></i>Question 13</a></li>
<li class="chapter" data-level="2.8.1" data-path="cross.html"><a href="cross.html#question-21"><i class="fa fa-check"></i><b>2.8.1</b> Question 21</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="chapter-3.html"><a href="chapter-3.html"><i class="fa fa-check"></i><b>3</b> Chapter 3</a></li>
<li class="chapter" data-level="" data-path="exercises-2.html"><a href="exercises-2.html"><i class="fa fa-check"></i>Exercises</a>
<ul>
<li class="chapter" data-level="" data-path="exercises-2.html"><a href="exercises-2.html#question-1-1"><i class="fa fa-check"></i>Question 1</a></li>
<li class="chapter" data-level="" data-path="exercises-2.html"><a href="exercises-2.html#question-2"><i class="fa fa-check"></i>Question 2</a></li>
<li class="chapter" data-level="" data-path="exercises-2.html"><a href="exercises-2.html#question-3-1"><i class="fa fa-check"></i>Question 3</a></li>
<li class="chapter" data-level="" data-path="exercises-2.html"><a href="exercises-2.html#question-4-independent-binomial"><i class="fa fa-check"></i>Question 4 (independent binomial)</a></li>
<li class="chapter" data-level="" data-path="exercises-2.html"><a href="exercises-2.html#question-4-dirichlet"><i class="fa fa-check"></i>Question 4 (dirichlet)</a></li>
<li class="chapter" data-level="" data-path="exercises-2.html"><a href="exercises-2.html#question-5"><i class="fa fa-check"></i>Question 5</a></li>
<li class="chapter" data-level="" data-path="exercises-2.html"><a href="exercises-2.html#question-6"><i class="fa fa-check"></i>Question 6</a></li>
<li class="chapter" data-level="" data-path="exercises-2.html"><a href="exercises-2.html#question-7-1"><i class="fa fa-check"></i>Question 7</a></li>
<li class="chapter" data-level="" data-path="exercises-2.html"><a href="exercises-2.html#question-8"><i class="fa fa-check"></i>question 8</a></li>
<li class="chapter" data-level="" data-path="exercises-2.html"><a href="exercises-2.html#question-9"><i class="fa fa-check"></i>question 9</a></li>
<li class="chapter" data-level="" data-path="exercises-2.html"><a href="exercises-2.html#question-11-1"><i class="fa fa-check"></i>Question 11</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="asymptotics-and-connections-to-non-bayesian-approaches.html"><a href="asymptotics-and-connections-to-non-bayesian-approaches.html"><i class="fa fa-check"></i><b>4</b> Asymptotics and connections to non-Bayesian approaches</a>
<ul>
<li class="chapter" data-level="4.1" data-path="asymptotics-and-connections-to-non-bayesian-approaches.html"><a href="asymptotics-and-connections-to-non-bayesian-approaches.html#normal-approximations-to-the-posterior-distribution"><i class="fa fa-check"></i><b>4.1</b> Normal approximations to the posterior distribution</a>
<ul>
<li class="chapter" data-level="" data-path="asymptotics-and-connections-to-non-bayesian-approaches.html"><a href="asymptotics-and-connections-to-non-bayesian-approaches.html#summarizing-posterior-distributions-by-point-estimates-and-standard-errors"><i class="fa fa-check"></i>Summarizing posterior distributions by point estimates and standard errors</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="asymptotics-and-connections-to-non-bayesian-approaches.html"><a href="asymptotics-and-connections-to-non-bayesian-approaches.html#large-sample-theory"><i class="fa fa-check"></i><b>4.2</b> Large-sample theory</a>
<ul>
<li class="chapter" data-level="" data-path="asymptotics-and-connections-to-non-bayesian-approaches.html"><a href="asymptotics-and-connections-to-non-bayesian-approaches.html#asymptotic-normality-and-consistency"><i class="fa fa-check"></i>Asymptotic normality and consistency</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="asymptotics-and-connections-to-non-bayesian-approaches.html"><a href="asymptotics-and-connections-to-non-bayesian-approaches.html#frequency-evaluations-of-bayesian-inferences"><i class="fa fa-check"></i><b>4.3</b> Frequency evaluations of Bayesian inferences</a>
<ul>
<li class="chapter" data-level="" data-path="asymptotics-and-connections-to-non-bayesian-approaches.html"><a href="asymptotics-and-connections-to-non-bayesian-approaches.html#large-sample-correspondence"><i class="fa fa-check"></i>Large sample correspondence</a></li>
<li class="chapter" data-level="" data-path="asymptotics-and-connections-to-non-bayesian-approaches.html"><a href="asymptotics-and-connections-to-non-bayesian-approaches.html#point-estimation-consistency-and-efficiency"><i class="fa fa-check"></i>Point estimation, consistency, and efficiency</a></li>
<li class="chapter" data-level="" data-path="asymptotics-and-connections-to-non-bayesian-approaches.html"><a href="asymptotics-and-connections-to-non-bayesian-approaches.html#confidence-coverage"><i class="fa fa-check"></i>Confidence coverage</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="asymptotics-and-connections-to-non-bayesian-approaches.html"><a href="asymptotics-and-connections-to-non-bayesian-approaches.html#exercises-3"><i class="fa fa-check"></i><b>4.4</b> Exercises</a>
<ul>
<li class="chapter" data-level="" data-path="asymptotics-and-connections-to-non-bayesian-approaches.html"><a href="asymptotics-and-connections-to-non-bayesian-approaches.html#question-1-2"><i class="fa fa-check"></i>Question 1</a></li>
<li class="chapter" data-level="" data-path="asymptotics-and-connections-to-non-bayesian-approaches.html"><a href="asymptotics-and-connections-to-non-bayesian-approaches.html#exercise-2"><i class="fa fa-check"></i>Exercise 2</a></li>
<li class="chapter" data-level="" data-path="asymptotics-and-connections-to-non-bayesian-approaches.html"><a href="asymptotics-and-connections-to-non-bayesian-approaches.html#exercise-3"><i class="fa fa-check"></i>Exercise 3</a></li>
<li class="chapter" data-level="4.4.1" data-path="asymptotics-and-connections-to-non-bayesian-approaches.html"><a href="asymptotics-and-connections-to-non-bayesian-approaches.html#question-4.2-using-the-posterior-sampling-via-grid-approach"><i class="fa fa-check"></i><b>4.4.1</b> Question 4.2 using the posterior sampling via grid approach</a></li>
<li class="chapter" data-level="4.4.2" data-path="asymptotics-and-connections-to-non-bayesian-approaches.html"><a href="asymptotics-and-connections-to-non-bayesian-approaches.html#taylor-series-approximation-of-the-information-matrix"><i class="fa fa-check"></i><b>4.4.2</b> Taylor series approximation of the information matrix</a></li>
<li class="chapter" data-level="" data-path="asymptotics-and-connections-to-non-bayesian-approaches.html"><a href="asymptotics-and-connections-to-non-bayesian-approaches.html#question-4-1"><i class="fa fa-check"></i>Question 4</a></li>
<li class="chapter" data-level="" data-path="asymptotics-and-connections-to-non-bayesian-approaches.html"><a href="asymptotics-and-connections-to-non-bayesian-approaches.html#question-5-1"><i class="fa fa-check"></i>Question 5</a></li>
<li class="chapter" data-level="" data-path="asymptotics-and-connections-to-non-bayesian-approaches.html"><a href="asymptotics-and-connections-to-non-bayesian-approaches.html#question-9-1"><i class="fa fa-check"></i>Question 9</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="hierarchical-models.html"><a href="hierarchical-models.html"><i class="fa fa-check"></i><b>5</b> Hierarchical Models</a>
<ul>
<li class="chapter" data-level="5.1" data-path="hierarchical-models.html"><a href="hierarchical-models.html#constructing-a-parameterized-prior-distribution"><i class="fa fa-check"></i><b>5.1</b> Constructing a parameterized prior distribution</a>
<ul>
<li class="chapter" data-level="" data-path="hierarchical-models.html"><a href="hierarchical-models.html#logic-of-combining-information"><i class="fa fa-check"></i>Logic of combining information</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="hierarchical-models.html"><a href="hierarchical-models.html#exchangeability-and-hierarchical-models"><i class="fa fa-check"></i><b>5.2</b> Exchangeability and hierarchical models</a>
<ul>
<li class="chapter" data-level="" data-path="hierarchical-models.html"><a href="hierarchical-models.html#exchangeability-1"><i class="fa fa-check"></i>Exchangeability</a></li>
<li class="chapter" data-level="" data-path="hierarchical-models.html"><a href="hierarchical-models.html#exchangeability-when-additional-information-is-available-on-the-units"><i class="fa fa-check"></i>Exchangeability when additional information is available on the units</a></li>
<li class="chapter" data-level="" data-path="hierarchical-models.html"><a href="hierarchical-models.html#objections-to-exchangeable-models"><i class="fa fa-check"></i>Objections to exchangeable models</a></li>
<li class="chapter" data-level="" data-path="hierarchical-models.html"><a href="hierarchical-models.html#the-full-bayesian-treatment-of-the-hierarchical-model"><i class="fa fa-check"></i>The full Bayesian treatment of the hierarchical model</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="hierarchical-models.html"><a href="hierarchical-models.html#the-hyperprior-distribution"><i class="fa fa-check"></i>The hyperprior distribution</a>
<ul>
<li class="chapter" data-level="" data-path="hierarchical-models.html"><a href="hierarchical-models.html#posterior-predictive-distribution-1"><i class="fa fa-check"></i>Posterior predictive distribution</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="hierarchical-models.html"><a href="hierarchical-models.html#bayesian-analysis-of-conjugate-hierarchical-models"><i class="fa fa-check"></i><b>5.3</b> Bayesian analysis of conjugate hierarchical models</a>
<ul>
<li class="chapter" data-level="" data-path="hierarchical-models.html"><a href="hierarchical-models.html#analytic-derivation-of-conditional-and-marginal-distributions"><i class="fa fa-check"></i>Analytic derivation of conditional and marginal distributions</a></li>
<li class="chapter" data-level="" data-path="hierarchical-models.html"><a href="hierarchical-models.html#drawing-simulations-from-the-posterior-distribution"><i class="fa fa-check"></i>Drawing simulations from the posterior distribution</a></li>
<li class="chapter" data-level="" data-path="hierarchical-models.html"><a href="hierarchical-models.html#application-to-the-model-for-rat-tumors"><i class="fa fa-check"></i>Application to the model for rat tumors</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="hierarchical-models.html"><a href="hierarchical-models.html#exercises-4"><i class="fa fa-check"></i>Exercises</a>
<ul>
<li class="chapter" data-level="" data-path="hierarchical-models.html"><a href="hierarchical-models.html#q1"><i class="fa fa-check"></i>Q1</a></li>
<li class="chapter" data-level="" data-path="hierarchical-models.html"><a href="hierarchical-models.html#q2"><i class="fa fa-check"></i>Q2</a></li>
<li class="chapter" data-level="" data-path="hierarchical-models.html"><a href="hierarchical-models.html#q3"><i class="fa fa-check"></i>Q3</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="sharing-your-book.html"><a href="sharing-your-book.html"><i class="fa fa-check"></i><b>6</b> Sharing your book</a>
<ul>
<li class="chapter" data-level="6.1" data-path="sharing-your-book.html"><a href="sharing-your-book.html#publishing"><i class="fa fa-check"></i><b>6.1</b> Publishing</a></li>
<li class="chapter" data-level="6.2" data-path="sharing-your-book.html"><a href="sharing-your-book.html#pages"><i class="fa fa-check"></i><b>6.2</b> 404 pages</a></li>
<li class="chapter" data-level="6.3" data-path="sharing-your-book.html"><a href="sharing-your-book.html#metadata-for-sharing"><i class="fa fa-check"></i><b>6.3</b> Metadata for sharing</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="chapter" data-level="7" data-path="parts.html"><a href="parts.html"><i class="fa fa-check"></i><b>7</b> Parts</a></li>
<li class="chapter" data-level="8" data-path="blocks.html"><a href="blocks.html"><i class="fa fa-check"></i><b>8</b> Blocks</a>
<ul>
<li class="chapter" data-level="8.1" data-path="blocks.html"><a href="blocks.html#equations"><i class="fa fa-check"></i><b>8.1</b> Equations</a></li>
<li class="chapter" data-level="8.2" data-path="blocks.html"><a href="blocks.html#theorems-and-proofs"><i class="fa fa-check"></i><b>8.2</b> Theorems and proofs</a></li>
<li class="chapter" data-level="8.3" data-path="blocks.html"><a href="blocks.html#callout-blocks"><i class="fa fa-check"></i><b>8.3</b> Callout blocks</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Bayesian Data Analysis</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="hierarchical-models" class="section level1 hasAnchor" number="5">
<h1><span class="header-section-number">Chapter 5</span> Hierarchical Models<a href="hierarchical-models.html#hierarchical-models" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Many problems involve multiple parameters that are related somehow by the structure of the problem. Each <span class="math inline">\(\theta_j\)</span> are viewed as a sample from a common <em>population distribution</em>, that is governed by <em>hyperparameters</em>.</p>
<p>Non-hierarchical models have inferior performance for prediction because they overfit the training data that only fit the current data well, this is because the uncertainty of the prior parameters are not included within the model. Hierarchical models avoid this problem because the model is structured around the dependence within the parameters.</p>
<div id="constructing-a-parameterized-prior-distribution" class="section level2 hasAnchor" number="5.1">
<h2><span class="header-section-number">5.1</span> Constructing a parameterized prior distribution<a href="hierarchical-models.html#constructing-a-parameterized-prior-distribution" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The example from 70 lab rat can use a fixed prior distribution under the binomial likelihood, and a beta prior. One can choose fixed estimates for the prior parameters <span class="math inline">\(\alpha,\beta\)</span>, or can use the moments to estimate the prior parameters. This is <em>not</em> a Bayesian model, and is considered an empirical Bayesian model. Given 70 historical experiments, the sample mean and sample variance are used to solve for the beta mean/variance <span class="math inline">\(\alpha/\beta\)</span> and <span class="math inline">\(\alpha/\beta^2\)</span>. Note that this is not a fully Bayesian approach.</p>
<div id="logic-of-combining-information" class="section level3 unnumbered hasAnchor">
<h3>Logic of combining information<a href="hierarchical-models.html#logic-of-combining-information" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Given 70 historical values, we combine all the parameters <span class="math inline">\(\theta_j\)</span>, for <span class="math inline">\(j=1,...,71\)</span> with the addition of a <em>newly</em> performed experiment. Combining these into a data set makes sense because there are some dependency of the parameters which is reflected into a full joint prior probability model.</p>
</div>
</div>
<div id="exchangeability-and-hierarchical-models" class="section level2 hasAnchor" number="5.2">
<h2><span class="header-section-number">5.2</span> Exchangeability and hierarchical models<a href="hierarchical-models.html#exchangeability-and-hierarchical-models" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Consider a set of experiments j=1,…,J in which j has the data <span class="math inline">\(y_j\)</span> and parameter <span class="math inline">\(\theta_j\)</span> with likelihood <span class="math inline">\(p(y_j|\theta_j)\)</span>. Let <span class="math inline">\(\theta_j \sim N(\mu_j,\sigma^2)\)</span> come from a superpopulation with common fixed variance.</p>
<div id="exchangeability-1" class="section level3 unnumbered hasAnchor">
<h3>Exchangeability<a href="hierarchical-models.html#exchangeability-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>If no information, other than the data <span class="math inline">\(y_j\)</span> is availble to distinguish any of the <span class="math inline">\(\theta_j\)</span> from any others, and no ordering or grouping of parameters can be made, then by symmetry among the parameters called <em>exchangeability</em>.
The joint distribution <span class="math inline">\(p(\theta_1,...,\theta_J)\)</span> is invariant to permutations of the indices (1,…,J). Generally, the less we know about a problem the more we can rely on the exchangeability assumption.</p>
<p>The form of exchangeabile distribution each parameter <span class="math inline">\(\theta_j\)</span> as an independent sample from a prior population distribution governed by some unknown <span class="math inline">\(\phi\)</span> is written as</p>
<p><span class="math display" id="eq:fiveOne">\[\begin{equation}
p(\theta|\phi) = \prod_j p(\theta_j| \phi)
\tag{5.1}
\end{equation}\]</span></p>
<p>in general <span class="math inline">\(\phi\)</span> is unknown so we average over the uncertainty of <span class="math inline">\(\phi\)</span></p>
<p><span class="math display">\[\begin{equation}
p(\theta) = \int \prod_j p(\theta_j| \phi)* p(\phi)d\phi
\end{equation}\]</span></p>
<p>This form is the mixture of independent identical distributions.</p>
<p>A related result <em>de Finetti’s theorem</em> states that as the limit of <span class="math inline">\(J\to \infty\)</span> any suitably exchangeable distribution on (<span class="math inline">\(\theta_1,...,\theta_J)\)</span> can be expressed as a mixture of identical and independent distributions. This theorem connects exchangeability to IID assumptions routinely practiced.</p>
</div>
<div id="exchangeability-when-additional-information-is-available-on-the-units" class="section level3 unnumbered hasAnchor">
<h3>Exchangeability when additional information is available on the units<a href="hierarchical-models.html#exchangeability-when-additional-information-is-available-on-the-units" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>observations often are not exchangeable, but are partially or <em>conditionally</em> exchangeable
- if observations can be grouped, we may make a hierarchical model where each group has its own sub-model, but the group properties are unknown. if we assume that the group properties are exchangeable, we can use a common prior distribution for the group properties.
- if <span class="math inline">\(y_i\)</span> has additional information <span class="math inline">\(x_i\)</span> so that <span class="math inline">\(y_i\)</span> are not exchangeable, but (<span class="math inline">\(y_i,x_i\)</span>) still are exchangeable, then we can make a joint prior for <span class="math inline">\((y_i,x_i)\)</span> or a condtional model <span class="math inline">\(y_i | x_i\)</span>.</p>
<p>For the rat example, if we knoew specific batches of experiments were made in different laboratories we could assume partial exchangeability and use two level hierarchical model to account for variation within each laboratory and between laboratories.</p>
<p>In general the usual way to model exchangeability with covariates is through conditional independence : $p(_1,…,_J) = (_j p(_j|,x_j))p(| x)d</p>
</div>
<div id="objections-to-exchangeable-models" class="section level3 unnumbered hasAnchor">
<h3>Objections to exchangeable models<a href="hierarchical-models.html#objections-to-exchangeable-models" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>it is natural to object to exchangeability on the grounds that the units actually differ. For the rat example, one can argue that different rats were studied at different times across different laboratories, and therefore not exchangeable. However this information does <strong>not</strong> invalidate exchangeability, these differences in experimental conditions imply that <span class="math inline">\(\theta_j\)</span> differ, but can still arise from a common parent distribution. If we had no information to distinguish them, we have a logical choice to assume exchangeability.</p>
</div>
<div id="the-full-bayesian-treatment-of-the-hierarchical-model" class="section level3 unnumbered hasAnchor">
<h3>The full Bayesian treatment of the hierarchical model<a href="hierarchical-models.html#the-full-bayesian-treatment-of-the-hierarchical-model" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>let <span class="math inline">\(\phi\)</span> be unknown with a prior <span class="math inline">\(p(\phi)\)</span> then the joint prior is</p>
<p><span class="math display">\[\begin{equation}
p(\phi,\theta) = p(\phi)p(\theta| \phi)
\end{equation}\]</span></p>
<p>and the joint posterior is</p>
<p><span class="math display">\[\begin{equation}
p(\phi,\theta | y) \propto p(\phi,\theta)p(y| \phi, \theta) = p(\phi,\theta)p(y|\theta)
\end{equation}\]</span></p>
<p>The <span class="math inline">\(p(y | \phi,\theta)\)</span> depends only on <span class="math inline">\(\theta\)</span> the hyperparameters <span class="math inline">\(\phi\)</span> only affects y through <span class="math inline">\(\theta\)</span>. This model includes the uncertainty about <span class="math inline">\(\phi\)</span> in the model.</p>
</div>
</div>
<div id="the-hyperprior-distribution" class="section level2 unnumbered hasAnchor">
<h2>The hyperprior distribution<a href="hierarchical-models.html#the-hyperprior-distribution" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In order to create a joint hyperprior for <span class="math inline">\((\phi,\theta)\)</span> we must assign a prior distribution to <span class="math inline">\(\phi\)</span>. If little is known about <span class="math inline">\(\phi\)</span> we can choose a diffuse prior, or noninformative prior, ensuring that the posterior is proper. Further assumptions about the prior must be checked for sensitivity in the hyperprior choice.</p>
<p>The rat example the hyperparameters are <span class="math inline">\((\alpha,\beta)\)</span> which determine the beta parameter <span class="math inline">\(\theta\)</span>.</p>
<div id="posterior-predictive-distribution-1" class="section level3 unnumbered hasAnchor">
<h3>Posterior predictive distribution<a href="hierarchical-models.html#posterior-predictive-distribution-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Hierarchical models are characterized by hyperparameters <span class="math inline">\(\phi\)</span> and model parameters <span class="math inline">\(\theta\)</span>. There are two posterior predictive distributions that might be an interest
- (1) the distribution of future observation <span class="math inline">\(\tilde{y}\)</span> corresponding to an existing <span class="math inline">\(\theta_j\)</span>.
- (2) the distribution of observations <span class="math inline">\(\tilde{y}\)</span> corresponding to future <span class="math inline">\(\theta_j\)</span>, <span class="math inline">\(\tilde{\theta}\)</span>, drawn from the same superpopulation, common, population</p>
</div>
</div>
<div id="bayesian-analysis-of-conjugate-hierarchical-models" class="section level2 hasAnchor" number="5.3">
<h2><span class="header-section-number">5.3</span> Bayesian analysis of conjugate hierarchical models<a href="hierarchical-models.html#bayesian-analysis-of-conjugate-hierarchical-models" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>For large number of parameters is it difficult to plot contour plots of the numerous parameters simulated from the joint posterior <span class="math inline">\((\phi,\theta)\)</span>. For the rat example, we obtain simulations of the posterior distribution <span class="math inline">\(p(\theta,\phi | y)\)</span> for the beta-binomial model for the rat-tumor for which the <strong>population distribution</strong> <span class="math inline">\(p(\theta|\phi)\)</span> is conjugate to the likelihood <span class="math inline">\(p(y | \theta)\)</span>. For non-conjugate models , we must use MCMC.</p>
<div id="analytic-derivation-of-conditional-and-marginal-distributions" class="section level3 unnumbered hasAnchor">
<h3>Analytic derivation of conditional and marginal distributions<a href="hierarchical-models.html#analytic-derivation-of-conditional-and-marginal-distributions" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<ul>
<li><ol style="list-style-type: decimal">
<li>write the joint posterior density <span class="math inline">\(p(\theta, \phi| y)\)</span> in unnormalized form as a product of the hyperprior density <span class="math inline">\(p(\phi)\)</span>, the <strong>population distribution</strong> <span class="math inline">\(p(\theta| \phi)\)</span> and the likelihood <span class="math inline">\(p(y|\theta)\)</span>.</li>
</ol></li>
<li><ol start="2" style="list-style-type: decimal">
<li>determine analytically the conditional posterior density of <span class="math inline">\(\theta\)</span> given the hyperparameter <span class="math inline">\(\phi\)</span>, for fixed observed y this is a function of <span class="math inline">\(\phi, p(\theta | \phi,y)\)</span>.</li>
</ol></li>
<li><ol start="3" style="list-style-type: decimal">
<li>estimate <span class="math inline">\(\phi\)</span> using the Bayesian paradigm, that is obtain its marginal posterior distribution <span class="math inline">\(p(\phi| y)\)</span>.</li>
</ol></li>
</ul>
<p>The first step is immediate, and the second step is easy for conjugate models because conditional on <span class="math inline">\(\phi\)</span> the population distribution for <span class="math inline">\(\theta\)</span> is just the independent and identical distribution model <a href="hierarchical-models.html#eq:fiveOne">(5.1)</a>. The conditional posterior density is a product of conjugate posterior densities for the components <span class="math inline">\(\theta_j\)</span>.</p>
<p>The marginal posterior <span class="math inline">\(p(\phi| y )\)</span> can be obtained using an integral
<span class="math display" id="eq:fiveFour">\[\begin{equation}
p(\phi|y) = \int p(\theta,\phi|y)d\theta
\tag{5.2}
\end{equation}\]</span></p>
<p>For many models the marginal computed using albegra and conditional probability formula
<span class="math display" id="eq:fiveFive">\[\begin{equation}
p(\phi|y) = \frac{ p(\theta,\phi|y)}{ p(\theta|\phi|y)}
\tag{5.3}
\end{equation}\]</span></p>
<p>This expression is useful because the numerator is just the joint posterior, and the denominator is the posterior distribution for <span class="math inline">\(\theta\)</span> if <span class="math inline">\(\phi\)</span> where known. So the denominator <span class="math inline">\(p(\theta| \phi, y)\)</span> is regarded as a function of both <span class="math inline">\(\theta\)</span> for fixed <span class="math inline">\(\phi, y\)</span>.</p>
</div>
<div id="drawing-simulations-from-the-posterior-distribution" class="section level3 unnumbered hasAnchor">
<h3>Drawing simulations from the posterior distribution<a href="hierarchical-models.html#drawing-simulations-from-the-posterior-distribution" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The strategy for simulating posterior distribution for <span class="math inline">\(p(\theta,\phi | y)\)</span> for simple hierarchical models follows</p>
<p>-(1) draw the vector of hyperparameters <span class="math inline">\(\phi\)</span> from its marginal posterior distribution <span class="math inline">\(p(\phi | y)\)</span>. If <span class="math inline">\(\phi\)</span> is low-dimensional, the methods in Chapter 3 can be used, and for high dimensional problems, MCMC must be used.
-(2) draw the parameter vector <span class="math inline">\(\theta\)</span> from its conditional posterior distribution <span class="math inline">\(p(\theta| \phi, y)\)</span> given the drawn value for <span class="math inline">\(\phi\)</span>. for simple examples <span class="math inline">\(p(\theta | \phi, y) = \prod p(\theta_j | \phi, y)\)</span> the components <span class="math inline">\(\theta_j\)</span> can be drawn independently, one at a time.
-(3) if desired, draw the predictive values <span class="math inline">\(\tilde{y}\)</span> from the posterior predictive distribution given the drawn <span class="math inline">\(\theta\)</span>. Depending on the problem it might be necessary to first draw <span class="math inline">\(\tilde{\theta}\)</span> given <span class="math inline">\(\phi\)</span>, and then draw a future value from the distribution.</p>
</div>
<div id="application-to-the-model-for-rat-tumors" class="section level3 unnumbered hasAnchor">
<h3>Application to the model for rat tumors<a href="hierarchical-models.html#application-to-the-model-for-rat-tumors" class="anchor-section" aria-label="Anchor link to header"></a></h3>
</div>
</div>
<div id="exercises-4" class="section level2 unnumbered hasAnchor">
<h2>Exercises<a href="hierarchical-models.html#exercises-4" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="q1" class="section level3 unnumbered hasAnchor">
<h3>Q1<a href="hierarchical-models.html#q1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>A box has 1 black and 1 white ball
- a i) pick 1 ball, y1, return it, and draw another y2. This is exchangeable, because other than y1, we have no information about what the draw y2 could be.<br />
- a ii) we have independence by replacement
- a iii) since the draws are identical, then y1 and y2 are both independent draws and the pair of draws can be independent.</p>
<p>-b i) drawing without replacement, y1 is not exchangeable because given y1 color, we know what y2 color is.
-b ii) not independent
-b iii) as a pair independent (RB) independent of a second pair (BR) with order then the order RB is independent of BR if order matters.</p>
<p>-c i) if there were a million balls, then due to large numbers this is an exchangeable and independent process.</p>
</div>
<div id="q2" class="section level3 unnumbered hasAnchor">
<h3>Q2<a href="hierarchical-models.html#q2" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>For unknown model parameters (a) we have total of n black and white balls, then this is an exchangeable and independent process. (b) due to ignorance we have exchangeability, but we do not have independence since this is without replacement. (c) if we know how many colors balls there are then this is not an exchangeable process and not independent process for finite n. For large n, then we can assume independence and exchangeability.</p>
</div>
<div id="q3" class="section level3 unnumbered hasAnchor">
<h3>Q3<a href="hierarchical-models.html#q3" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>all 8 parameters are estimated from sampling from the posterior <span class="math inline">\(p(\tau | y)\)</span>, for ease of data wrangling, we obtain the quantiles for each theta separately. but in each posterior estimation, all points are simulataneously estimated.</p>
<p>This reproduces Table 5.3 from the text.</p>
<div class="sourceCode" id="cb316"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb316-1"><a href="hierarchical-models.html#cb316-1" aria-hidden="true" tabindex="-1"></a>school<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="at">school=</span>LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>],</span>
<span id="cb316-2"><a href="hierarchical-models.html#cb316-2" aria-hidden="true" tabindex="-1"></a>                   <span class="at">yj =</span><span class="fu">c</span>(<span class="dv">28</span>,<span class="dv">8</span>,<span class="sc">-</span><span class="dv">3</span>,<span class="dv">7</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">18</span>,<span class="dv">12</span>),</span>
<span id="cb316-3"><a href="hierarchical-models.html#cb316-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">sigmaj =</span> <span class="fu">c</span>(<span class="dv">15</span>,<span class="dv">10</span>,<span class="dv">16</span>,<span class="dv">11</span>,<span class="dv">9</span>,<span class="dv">11</span>,<span class="dv">10</span>,<span class="dv">18</span>))</span>
<span id="cb316-4"><a href="hierarchical-models.html#cb316-4" aria-hidden="true" tabindex="-1"></a>school<span class="sc">$</span>sigma2j<span class="ot">&lt;-</span>school<span class="sc">$</span>sigmaj<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb316-5"><a href="hierarchical-models.html#cb316-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb316-6"><a href="hierarchical-models.html#cb316-6" aria-hidden="true" tabindex="-1"></a> <span class="do">## reproducing section 5.5 on pooling</span></span>
<span id="cb316-7"><a href="hierarchical-models.html#cb316-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb316-8"><a href="hierarchical-models.html#cb316-8" aria-hidden="true" tabindex="-1"></a><span class="do">## pooled</span></span>
<span id="cb316-9"><a href="hierarchical-models.html#cb316-9" aria-hidden="true" tabindex="-1"></a> ybar_pool<span class="ot">&lt;-</span><span class="fu">sum</span>(school<span class="sc">$</span>yj<span class="sc">/</span>school<span class="sc">$</span>sigmaj<span class="sc">^</span><span class="dv">2</span>)<span class="sc">/</span><span class="fu">sum</span>(<span class="dv">1</span><span class="sc">/</span>school<span class="sc">$</span>sigmaj<span class="sc">^</span><span class="dv">2</span>) </span>
<span id="cb316-10"><a href="hierarchical-models.html#cb316-10" aria-hidden="true" tabindex="-1"></a> pool_var<span class="ot">&lt;-</span><span class="dv">1</span><span class="sc">/</span><span class="fu">sum</span>(<span class="dv">1</span><span class="sc">/</span>school<span class="sc">$</span>sigmaj<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb316-11"><a href="hierarchical-models.html#cb316-11" aria-hidden="true" tabindex="-1"></a>  ybar_pool<span class="sc">+</span><span class="dv">2</span><span class="sc">*</span><span class="fu">sqrt</span>(pool_var) <span class="co"># 15.82946</span></span></code></pre></div>
<pre><code>## [1] 15.82946</code></pre>
<div class="sourceCode" id="cb318"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb318-1"><a href="hierarchical-models.html#cb318-1" aria-hidden="true" tabindex="-1"></a>  ybar_pool<span class="dv">-2</span><span class="sc">*</span><span class="fu">sqrt</span>(pool_var) <span class="do">## -0.5</span></span></code></pre></div>
<pre><code>## [1] -0.4582216</code></pre>
<div class="sourceCode" id="cb320"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb320-1"><a href="hierarchical-models.html#cb320-1" aria-hidden="true" tabindex="-1"></a> <span class="do">## classical test</span></span>
<span id="cb320-2"><a href="hierarchical-models.html#cb320-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">sum</span>( (school<span class="sc">$</span>yj<span class="sc">-</span><span class="fu">mean</span>(school<span class="sc">$</span>yj))<span class="sc">^</span><span class="dv">2</span><span class="sc">/</span>school<span class="sc">$</span>sigmaj<span class="sc">^</span><span class="dv">2</span>)  <span class="do">## 4.7 which is less than the X2 d.f (8) so MSB- MSW is negative.  pooling is not appropriate.</span></span></code></pre></div>
<pre><code>## [1] 4.775407</code></pre>
<div class="sourceCode" id="cb322"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb322-1"><a href="hierarchical-models.html#cb322-1" aria-hidden="true" tabindex="-1"></a>   <span class="do">## checking to see if 28 is from the pooled population </span></span>
<span id="cb322-2"><a href="hierarchical-models.html#cb322-2" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb322-3"><a href="hierarchical-models.html#cb322-3" aria-hidden="true" tabindex="-1"></a>   simschool <span class="ot">&lt;-</span><span class="fu">rnorm</span>(<span class="dv">1000</span>, <span class="at">mean=</span> ybar_pool, <span class="at">sd=</span><span class="fu">sqrt</span>(pool_var))   </span>
<span id="cb322-4"><a href="hierarchical-models.html#cb322-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">hist</span>(simschool,<span class="at">xlim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">8</span>,<span class="dv">30</span>))</span>
<span id="cb322-5"><a href="hierarchical-models.html#cb322-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">abline</span>(<span class="at">v=</span><span class="fu">max</span>(school<span class="sc">$</span>yj ))</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-65-1.png" width="672" /></p>
<div class="sourceCode" id="cb323"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb323-1"><a href="hierarchical-models.html#cb323-1" aria-hidden="true" tabindex="-1"></a>   <span class="do">### the maximum observation  School A = 28 points  is not with the population, so pooling does not correct</span></span>
<span id="cb323-2"><a href="hierarchical-models.html#cb323-2" aria-hidden="true" tabindex="-1"></a>   <span class="do">###</span></span>
<span id="cb323-3"><a href="hierarchical-models.html#cb323-3" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb323-4"><a href="hierarchical-models.html#cb323-4" aria-hidden="true" tabindex="-1"></a>   <span class="do">## posterior simulation under a normal model</span></span>
<span id="cb323-5"><a href="hierarchical-models.html#cb323-5" aria-hidden="true" tabindex="-1"></a>   <span class="do">## yij | thetaj ~ N(thetaj, sigma^2)</span></span>
<span id="cb323-6"><a href="hierarchical-models.html#cb323-6" aria-hidden="true" tabindex="-1"></a>   <span class="do">##  likelihood using sufficient statistics  </span></span>
<span id="cb323-7"><a href="hierarchical-models.html#cb323-7" aria-hidden="true" tabindex="-1"></a>    <span class="do">## ybarj | thetaj ~ N(thetaj, sigmaj^2)</span></span>
<span id="cb323-8"><a href="hierarchical-models.html#cb323-8" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb323-9"><a href="hierarchical-models.html#cb323-9" aria-hidden="true" tabindex="-1"></a>   <span class="do">### prior on tau can follow a uniform distribution</span></span>
<span id="cb323-10"><a href="hierarchical-models.html#cb323-10" aria-hidden="true" tabindex="-1"></a>   <span class="do">## using a grid approach for tau</span></span>
<span id="cb323-11"><a href="hierarchical-models.html#cb323-11" aria-hidden="true" tabindex="-1"></a>      tau0<span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">40</span>,<span class="at">by=</span><span class="fl">0.01</span>)</span>
<span id="cb323-12"><a href="hierarchical-models.html#cb323-12" aria-hidden="true" tabindex="-1"></a>      stepsize<span class="ot">=</span><span class="fl">0.01</span></span>
<span id="cb323-13"><a href="hierarchical-models.html#cb323-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 5.20 total precision  </span></span>
<span id="cb323-14"><a href="hierarchical-models.html#cb323-14" aria-hidden="true" tabindex="-1"></a>  vmu.inverse<span class="ot">&lt;-</span><span class="cf">function</span>(tau2,sigma2j){</span>
<span id="cb323-15"><a href="hierarchical-models.html#cb323-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(<span class="dv">1</span><span class="sc">/</span>(sigma2j<span class="sc">+</span>tau2))</span>
<span id="cb323-16"><a href="hierarchical-models.html#cb323-16" aria-hidden="true" tabindex="-1"></a>  }      </span>
<span id="cb323-17"><a href="hierarchical-models.html#cb323-17" aria-hidden="true" tabindex="-1"></a>  vmu<span class="ot">&lt;-</span><span class="fu">sapply</span>(tau0<span class="sc">^</span><span class="dv">2</span>,<span class="cf">function</span>(x) <span class="fu">vmu.inverse</span>(x,school<span class="sc">$</span>sigmaj<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb323-18"><a href="hierarchical-models.html#cb323-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb323-19"><a href="hierarchical-models.html#cb323-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># total mean effect</span></span>
<span id="cb323-20"><a href="hierarchical-models.html#cb323-20" aria-hidden="true" tabindex="-1"></a>  muhat<span class="ot">&lt;-</span><span class="cf">function</span>(ybarj, sigma2j,tau2){</span>
<span id="cb323-21"><a href="hierarchical-models.html#cb323-21" aria-hidden="true" tabindex="-1"></a>    numer<span class="ot">&lt;-</span> <span class="fu">sum</span>(ybarj<span class="sc">/</span>(sigma2j<span class="sc">+</span>tau2))</span>
<span id="cb323-22"><a href="hierarchical-models.html#cb323-22" aria-hidden="true" tabindex="-1"></a>    denom<span class="ot">&lt;-</span> <span class="fu">sum</span>( <span class="dv">1</span><span class="sc">/</span>(sigma2j<span class="sc">+</span>tau2))</span>
<span id="cb323-23"><a href="hierarchical-models.html#cb323-23" aria-hidden="true" tabindex="-1"></a>    hat<span class="ot">&lt;-</span> numer<span class="sc">/</span>denom</span>
<span id="cb323-24"><a href="hierarchical-models.html#cb323-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(hat)</span>
<span id="cb323-25"><a href="hierarchical-models.html#cb323-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb323-26"><a href="hierarchical-models.html#cb323-26" aria-hidden="true" tabindex="-1"></a>    <span class="do">## marginal posterior distribution p(tau| y)  5.21</span></span>
<span id="cb323-27"><a href="hierarchical-models.html#cb323-27" aria-hidden="true" tabindex="-1"></a>  marginal.posterior.tau<span class="ot">&lt;-</span><span class="cf">function</span>(tau,sigma2j,ybarj){</span>
<span id="cb323-28"><a href="hierarchical-models.html#cb323-28" aria-hidden="true" tabindex="-1"></a>    tau2<span class="ot">&lt;-</span>tau<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb323-29"><a href="hierarchical-models.html#cb323-29" aria-hidden="true" tabindex="-1"></a>    prob.tau<span class="ot">&lt;-</span><span class="fu">dunif</span>(tau,<span class="at">min=</span><span class="dv">0</span>,<span class="at">max=</span><span class="dv">40</span>) <span class="do">## assuming unif prior</span></span>
<span id="cb323-30"><a href="hierarchical-models.html#cb323-30" aria-hidden="true" tabindex="-1"></a>    vmu.inv<span class="ot">&lt;-</span><span class="fu">vmu.inverse</span>(tau2,sigma2j)</span>
<span id="cb323-31"><a href="hierarchical-models.html#cb323-31" aria-hidden="true" tabindex="-1"></a>    vmu<span class="ot">&lt;-</span><span class="fu">sqrt</span>(<span class="dv">1</span><span class="sc">/</span>vmu.inv)</span>
<span id="cb323-32"><a href="hierarchical-models.html#cb323-32" aria-hidden="true" tabindex="-1"></a>    total.precision<span class="ot">&lt;-</span><span class="dv">1</span><span class="sc">/</span>(sigma2j<span class="sc">+</span>tau2)</span>
<span id="cb323-33"><a href="hierarchical-models.html#cb323-33" aria-hidden="true" tabindex="-1"></a>    group.precision.term<span class="ot">&lt;-</span> <span class="fu">sqrt</span>(total.precision)</span>
<span id="cb323-34"><a href="hierarchical-models.html#cb323-34" aria-hidden="true" tabindex="-1"></a>    group.mu<span class="ot">&lt;-</span><span class="fu">muhat</span>(ybarj,sigma2j,tau2)</span>
<span id="cb323-35"><a href="hierarchical-models.html#cb323-35" aria-hidden="true" tabindex="-1"></a>    exp.term<span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="dv">1</span><span class="sc">*</span>(ybarj <span class="sc">-</span>group.mu )<span class="sc">^</span><span class="dv">2</span><span class="sc">/</span>(<span class="dv">2</span><span class="sc">*</span>(sigma2j<span class="sc">+</span>tau2)))</span>
<span id="cb323-36"><a href="hierarchical-models.html#cb323-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb323-37"><a href="hierarchical-models.html#cb323-37" aria-hidden="true" tabindex="-1"></a>    group.prod<span class="ot">&lt;-</span><span class="fu">prod</span>( group.precision.term<span class="sc">*</span>exp.term)</span>
<span id="cb323-38"><a href="hierarchical-models.html#cb323-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb323-39"><a href="hierarchical-models.html#cb323-39" aria-hidden="true" tabindex="-1"></a>    final<span class="ot">&lt;-</span> prob.tau<span class="sc">*</span>vmu<span class="sc">*</span>group.prod</span>
<span id="cb323-40"><a href="hierarchical-models.html#cb323-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(final)</span>
<span id="cb323-41"><a href="hierarchical-models.html#cb323-41" aria-hidden="true" tabindex="-1"></a>  }  </span>
<span id="cb323-42"><a href="hierarchical-models.html#cb323-42" aria-hidden="true" tabindex="-1"></a>  tt<span class="ot">&lt;-</span><span class="fu">data.frame</span>(tau0,<span class="at">pt=</span><span class="fu">sapply</span>(tau0,<span class="cf">function</span>(x) <span class="fu">marginal.posterior.tau</span>(x,school<span class="sc">$</span>sigma2j,school<span class="sc">$</span>yj)))</span>
<span id="cb323-43"><a href="hierarchical-models.html#cb323-43" aria-hidden="true" tabindex="-1"></a>  tt<span class="sc">$</span>scaled.prob<span class="ot">&lt;-</span>tt<span class="sc">$</span>pt<span class="sc">/</span><span class="fu">sum</span>(tt<span class="sc">$</span>pt)</span>
<span id="cb323-44"><a href="hierarchical-models.html#cb323-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(tt<span class="sc">$</span>tau0,tt<span class="sc">$</span>scaled.prob, <span class="at">main=</span><span class="st">&#39;marginal poster p(tau|y) Figure 5.5&#39;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-65-2.png" width="672" /></p>
<div class="sourceCode" id="cb324"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb324-1"><a href="hierarchical-models.html#cb324-1" aria-hidden="true" tabindex="-1"></a>   <span class="do">## prior on tau can follow a scaled inverse-X2(n-1,s^2) distribution</span></span>
<span id="cb324-2"><a href="hierarchical-models.html#cb324-2" aria-hidden="true" tabindex="-1"></a> <span class="do">## alternatively we can use scaled inverse</span></span>
<span id="cb324-3"><a href="hierarchical-models.html#cb324-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb324-4"><a href="hierarchical-models.html#cb324-4" aria-hidden="true" tabindex="-1"></a>  <span class="do">## now that we have the distribution of tau,  sample from it</span></span>
<span id="cb324-5"><a href="hierarchical-models.html#cb324-5" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb324-6"><a href="hierarchical-models.html#cb324-6" aria-hidden="true" tabindex="-1"></a>   <span class="do">## marginal posterior 5.19</span></span>
<span id="cb324-7"><a href="hierarchical-models.html#cb324-7" aria-hidden="true" tabindex="-1"></a>  muhat_given_tau.y<span class="ot">&lt;-</span><span class="fu">sapply</span>(tau0,<span class="cf">function</span>(x) <span class="fu">muhat</span>(school<span class="sc">$</span>yj,school<span class="sc">$</span>sigma2j,x<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb324-8"><a href="hierarchical-models.html#cb324-8" aria-hidden="true" tabindex="-1"></a>    vmu_given_tau.y<span class="ot">&lt;-</span><span class="dv">1</span><span class="sc">/</span>(<span class="fu">sapply</span>(tau0<span class="sc">^</span><span class="dv">2</span>,<span class="cf">function</span>(x) <span class="fu">vmu.inverse</span>(x,school<span class="sc">$</span>sigmaj<span class="sc">^</span><span class="dv">2</span>)))</span>
<span id="cb324-9"><a href="hierarchical-models.html#cb324-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb324-10"><a href="hierarchical-models.html#cb324-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb324-11"><a href="hierarchical-models.html#cb324-11" aria-hidden="true" tabindex="-1"></a>     <span class="do">### FIX ME:  sample mu</span></span>
<span id="cb324-12"><a href="hierarchical-models.html#cb324-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># equation 5.20</span></span>
<span id="cb324-13"><a href="hierarchical-models.html#cb324-13" aria-hidden="true" tabindex="-1"></a>   marginal.post.mu_given_tau.y<span class="ot">&lt;-</span><span class="cf">function</span>(yj,sigma2j,tau2){</span>
<span id="cb324-14"><a href="hierarchical-models.html#cb324-14" aria-hidden="true" tabindex="-1"></a>     muhat<span class="ot">&lt;-</span><span class="fu">muhat</span>(yj,sigma2j,tau2)</span>
<span id="cb324-15"><a href="hierarchical-models.html#cb324-15" aria-hidden="true" tabindex="-1"></a>     <span class="do">## precision term</span></span>
<span id="cb324-16"><a href="hierarchical-models.html#cb324-16" aria-hidden="true" tabindex="-1"></a>     vmu<span class="ot">&lt;-</span><span class="fu">vmu.inverse</span>(tau2,sigma2j)</span>
<span id="cb324-17"><a href="hierarchical-models.html#cb324-17" aria-hidden="true" tabindex="-1"></a>    mu<span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">100</span>,<span class="at">mean=</span>muhat,<span class="at">sd=</span><span class="fu">sqrt</span>(<span class="dv">1</span><span class="sc">/</span>vmu)) <span class="do">## how many points per posterior tau</span></span>
<span id="cb324-18"><a href="hierarchical-models.html#cb324-18" aria-hidden="true" tabindex="-1"></a>    <span class="do">## we take the posterior mean given 1 value of tau</span></span>
<span id="cb324-19"><a href="hierarchical-models.html#cb324-19" aria-hidden="true" tabindex="-1"></a>    prob.mu<span class="ot">&lt;-</span><span class="fu">dnorm</span>(<span class="fu">mean</span>(mu),<span class="at">mean=</span>muhat,<span class="at">sd=</span><span class="fu">sqrt</span>(<span class="dv">1</span><span class="sc">/</span>vmu))</span>
<span id="cb324-20"><a href="hierarchical-models.html#cb324-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>( <span class="fu">data.frame</span>(<span class="at">mu=</span><span class="fu">mean</span>(mu),<span class="at">prob.mu=</span>prob.mu))</span>
<span id="cb324-21"><a href="hierarchical-models.html#cb324-21" aria-hidden="true" tabindex="-1"></a>   }</span>
<span id="cb324-22"><a href="hierarchical-models.html#cb324-22" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb324-23"><a href="hierarchical-models.html#cb324-23" aria-hidden="true" tabindex="-1"></a>   <span class="do">## given mu, sample theta j      </span></span>
<span id="cb324-24"><a href="hierarchical-models.html#cb324-24" aria-hidden="true" tabindex="-1"></a>   <span class="do">## conditional posterior for each theta j </span></span>
<span id="cb324-25"><a href="hierarchical-models.html#cb324-25" aria-hidden="true" tabindex="-1"></a>   <span class="do">## eq 5.17</span></span>
<span id="cb324-26"><a href="hierarchical-models.html#cb324-26" aria-hidden="true" tabindex="-1"></a>  conditional.posterior.thetaj<span class="ot">&lt;-</span><span class="cf">function</span>(yj,sigma2j,tau2,mu){</span>
<span id="cb324-27"><a href="hierarchical-models.html#cb324-27" aria-hidden="true" tabindex="-1"></a>     thetajhat<span class="ot">&lt;-</span>(yj<span class="sc">/</span>sigma2j <span class="sc">+</span> mu<span class="sc">/</span>tau2)<span class="sc">/</span>(<span class="dv">1</span><span class="sc">/</span>sigma2j<span class="sc">+</span><span class="dv">1</span><span class="sc">/</span>tau2)</span>
<span id="cb324-28"><a href="hierarchical-models.html#cb324-28" aria-hidden="true" tabindex="-1"></a>     vj<span class="ot">&lt;-</span><span class="dv">1</span><span class="sc">/</span>((<span class="dv">1</span><span class="sc">/</span>sigma2j)<span class="sc">+</span>(<span class="dv">1</span><span class="sc">/</span>tau2))</span>
<span id="cb324-29"><a href="hierarchical-models.html#cb324-29" aria-hidden="true" tabindex="-1"></a>     nj<span class="ot">&lt;-</span><span class="fu">length</span>(thetajhat)</span>
<span id="cb324-30"><a href="hierarchical-models.html#cb324-30" aria-hidden="true" tabindex="-1"></a>    thetaj<span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="fu">seq</span>(<span class="dv">1</span>,nj),<span class="cf">function</span>(x) <span class="fu">rnorm</span>(<span class="dv">1</span>, thetajhat[x], <span class="at">sd=</span><span class="fu">sqrt</span>(vj)[x]))</span>
<span id="cb324-31"><a href="hierarchical-models.html#cb324-31" aria-hidden="true" tabindex="-1"></a>    prob.thetaj<span class="ot">&lt;-</span><span class="fu">numeric</span>(nj)</span>
<span id="cb324-32"><a href="hierarchical-models.html#cb324-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb324-33"><a href="hierarchical-models.html#cb324-33" aria-hidden="true" tabindex="-1"></a>    prob.thetaj<span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="fu">seq</span>(<span class="dv">1</span>,nj),<span class="cf">function</span>(x) <span class="fu">dnorm</span>(thetaj[x], <span class="at">mean=</span>thetajhat[x], <span class="at">sd=</span><span class="fu">sqrt</span>(vj)[x]))</span>
<span id="cb324-34"><a href="hierarchical-models.html#cb324-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb324-35"><a href="hierarchical-models.html#cb324-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb324-36"><a href="hierarchical-models.html#cb324-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>( <span class="fu">data.frame</span>(<span class="at">thetaj=</span>(thetaj),<span class="at">prob.thetaj=</span>prob.thetaj))</span>
<span id="cb324-37"><a href="hierarchical-models.html#cb324-37" aria-hidden="true" tabindex="-1"></a>   }</span>
<span id="cb324-38"><a href="hierarchical-models.html#cb324-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb324-39"><a href="hierarchical-models.html#cb324-39" aria-hidden="true" tabindex="-1"></a>  posterior<span class="ot">&lt;-</span><span class="cf">function</span>(tau,sigma2j,yj){</span>
<span id="cb324-40"><a href="hierarchical-models.html#cb324-40" aria-hidden="true" tabindex="-1"></a>    tau2<span class="ot">&lt;-</span>tau<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb324-41"><a href="hierarchical-models.html#cb324-41" aria-hidden="true" tabindex="-1"></a>    post.tau<span class="ot">&lt;-</span><span class="fu">marginal.posterior.tau</span>(tau,sigma2j,yj)</span>
<span id="cb324-42"><a href="hierarchical-models.html#cb324-42" aria-hidden="true" tabindex="-1"></a>    post.mu<span class="ot">&lt;-</span><span class="fu">marginal.post.mu_given_tau.y</span>(yj,sigma2j,tau2)</span>
<span id="cb324-43"><a href="hierarchical-models.html#cb324-43" aria-hidden="true" tabindex="-1"></a>    post.theta<span class="ot">&lt;-</span><span class="fu">conditional.posterior.thetaj</span>(yj,sigma2j,tau2,post.mu<span class="sc">$</span>mu)</span>
<span id="cb324-44"><a href="hierarchical-models.html#cb324-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb324-45"><a href="hierarchical-models.html#cb324-45" aria-hidden="true" tabindex="-1"></a>      full.post<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="at">theta=</span>post.theta<span class="sc">$</span>thetaj,<span class="at">pdf=</span>post.tau<span class="sc">*</span>post.mu<span class="sc">$</span>prob.mu<span class="sc">*</span>post.theta<span class="sc">$</span>prob.thetaj)</span>
<span id="cb324-46"><a href="hierarchical-models.html#cb324-46" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(full.post)</span>
<span id="cb324-47"><a href="hierarchical-models.html#cb324-47" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb324-48"><a href="hierarchical-models.html#cb324-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb324-49"><a href="hierarchical-models.html#cb324-49" aria-hidden="true" tabindex="-1"></a>  <span class="do">## simulate the effects of thetaj</span></span>
<span id="cb324-50"><a href="hierarchical-models.html#cb324-50" aria-hidden="true" tabindex="-1"></a>  <span class="do">## closely reproduces table 5.3 in section 5</span></span>
<span id="cb324-51"><a href="hierarchical-models.html#cb324-51" aria-hidden="true" tabindex="-1"></a>  theta1<span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="fu">sample</span>(tt<span class="sc">$</span>tau0,<span class="dv">1000</span>,<span class="at">prob=</span>tt<span class="sc">$</span>scaled.prob),</span>
<span id="cb324-52"><a href="hierarchical-models.html#cb324-52" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">function</span>(x) <span class="fu">posterior</span>(x,school<span class="sc">$</span>sigma2j,school<span class="sc">$</span>yj)[<span class="dv">1</span>,<span class="dv">1</span>])</span>
<span id="cb324-53"><a href="hierarchical-models.html#cb324-53" aria-hidden="true" tabindex="-1"></a>  theta1[<span class="fu">is.nan</span>(theta1)]<span class="ot">&lt;-</span><span class="fu">mean</span>(theta1[<span class="sc">!</span><span class="fu">is.nan</span>(theta1)])</span>
<span id="cb324-54"><a href="hierarchical-models.html#cb324-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb324-55"><a href="hierarchical-models.html#cb324-55" aria-hidden="true" tabindex="-1"></a>  t1q<span class="ot">&lt;-</span><span class="fu">quantile</span>(theta1,<span class="fu">c</span>(<span class="fl">0.025</span>,<span class="fl">0.25</span>,<span class="fl">0.5</span>,<span class="fl">0.75</span>,<span class="fl">0.975</span>),<span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb324-56"><a href="hierarchical-models.html#cb324-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb324-57"><a href="hierarchical-models.html#cb324-57" aria-hidden="true" tabindex="-1"></a>   theta2<span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="fu">sample</span>(tt<span class="sc">$</span>tau0,<span class="dv">1000</span>,<span class="at">prob=</span>tt<span class="sc">$</span>scaled.prob),</span>
<span id="cb324-58"><a href="hierarchical-models.html#cb324-58" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">function</span>(x) <span class="fu">posterior</span>(x,school<span class="sc">$</span>sigma2j,school<span class="sc">$</span>yj)[<span class="dv">2</span>,<span class="dv">1</span>])</span>
<span id="cb324-59"><a href="hierarchical-models.html#cb324-59" aria-hidden="true" tabindex="-1"></a>  theta2[<span class="fu">is.nan</span>(theta2)]<span class="ot">&lt;-</span><span class="fu">mean</span>(theta2[<span class="sc">!</span><span class="fu">is.nan</span>(theta2)])</span>
<span id="cb324-60"><a href="hierarchical-models.html#cb324-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb324-61"><a href="hierarchical-models.html#cb324-61" aria-hidden="true" tabindex="-1"></a>  t2q<span class="ot">&lt;-</span><span class="fu">quantile</span>(theta2,<span class="fu">c</span>(<span class="fl">0.025</span>,<span class="fl">0.25</span>,<span class="fl">0.5</span>,<span class="fl">0.75</span>,<span class="fl">0.975</span>),<span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb324-62"><a href="hierarchical-models.html#cb324-62" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb324-63"><a href="hierarchical-models.html#cb324-63" aria-hidden="true" tabindex="-1"></a>   theta3<span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="fu">sample</span>(tt<span class="sc">$</span>tau0,<span class="dv">1000</span>,<span class="at">prob=</span>tt<span class="sc">$</span>scaled.prob),</span>
<span id="cb324-64"><a href="hierarchical-models.html#cb324-64" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">function</span>(x) <span class="fu">posterior</span>(x,school<span class="sc">$</span>sigma2j,school<span class="sc">$</span>yj)[<span class="dv">3</span>,<span class="dv">1</span>])</span>
<span id="cb324-65"><a href="hierarchical-models.html#cb324-65" aria-hidden="true" tabindex="-1"></a>      theta3[<span class="fu">is.nan</span>(theta3)]<span class="ot">&lt;-</span><span class="fu">mean</span>(theta3[<span class="sc">!</span><span class="fu">is.nan</span>(theta3)])</span>
<span id="cb324-66"><a href="hierarchical-models.html#cb324-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb324-67"><a href="hierarchical-models.html#cb324-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb324-68"><a href="hierarchical-models.html#cb324-68" aria-hidden="true" tabindex="-1"></a>  t3q<span class="ot">&lt;-</span><span class="fu">quantile</span>(theta3,<span class="fu">c</span>(<span class="fl">0.025</span>,<span class="fl">0.25</span>,<span class="fl">0.5</span>,<span class="fl">0.75</span>,<span class="fl">0.975</span>),<span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb324-69"><a href="hierarchical-models.html#cb324-69" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb324-70"><a href="hierarchical-models.html#cb324-70" aria-hidden="true" tabindex="-1"></a>   theta4<span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="fu">sample</span>(tt<span class="sc">$</span>tau0,<span class="dv">1000</span>,<span class="at">prob=</span>tt<span class="sc">$</span>scaled.prob),</span>
<span id="cb324-71"><a href="hierarchical-models.html#cb324-71" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">function</span>(x) <span class="fu">posterior</span>(x,school<span class="sc">$</span>sigma2j,school<span class="sc">$</span>yj)[<span class="dv">4</span>,<span class="dv">1</span>])</span>
<span id="cb324-72"><a href="hierarchical-models.html#cb324-72" aria-hidden="true" tabindex="-1"></a>       theta4[<span class="fu">is.nan</span>(theta4)]<span class="ot">&lt;-</span><span class="fu">mean</span>(theta4[<span class="sc">!</span><span class="fu">is.nan</span>(theta4)])</span>
<span id="cb324-73"><a href="hierarchical-models.html#cb324-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb324-74"><a href="hierarchical-models.html#cb324-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb324-75"><a href="hierarchical-models.html#cb324-75" aria-hidden="true" tabindex="-1"></a> t4q<span class="ot">&lt;-</span> <span class="fu">quantile</span>(theta4,<span class="fu">c</span>(<span class="fl">0.025</span>,<span class="fl">0.25</span>,<span class="fl">0.5</span>,<span class="fl">0.75</span>,<span class="fl">0.975</span>),<span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb324-76"><a href="hierarchical-models.html#cb324-76" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb324-77"><a href="hierarchical-models.html#cb324-77" aria-hidden="true" tabindex="-1"></a>   theta5<span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="fu">sample</span>(tt<span class="sc">$</span>tau0,<span class="dv">1000</span>,<span class="at">prob=</span>tt<span class="sc">$</span>scaled.prob),</span>
<span id="cb324-78"><a href="hierarchical-models.html#cb324-78" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">function</span>(x) <span class="fu">posterior</span>(x,school<span class="sc">$</span>sigma2j,school<span class="sc">$</span>yj)[<span class="dv">5</span>,<span class="dv">1</span>])</span>
<span id="cb324-79"><a href="hierarchical-models.html#cb324-79" aria-hidden="true" tabindex="-1"></a>    theta5[<span class="fu">is.nan</span>(theta5)]<span class="ot">&lt;-</span><span class="fu">mean</span>(theta5[<span class="sc">!</span><span class="fu">is.nan</span>(theta5)])</span>
<span id="cb324-80"><a href="hierarchical-models.html#cb324-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb324-81"><a href="hierarchical-models.html#cb324-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb324-82"><a href="hierarchical-models.html#cb324-82" aria-hidden="true" tabindex="-1"></a> t5q<span class="ot">&lt;-</span> <span class="fu">quantile</span>(theta5,<span class="fu">c</span>(<span class="fl">0.025</span>,<span class="fl">0.25</span>,<span class="fl">0.5</span>,<span class="fl">0.75</span>,<span class="fl">0.975</span>),<span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb324-83"><a href="hierarchical-models.html#cb324-83" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb324-84"><a href="hierarchical-models.html#cb324-84" aria-hidden="true" tabindex="-1"></a>   theta6<span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="fu">sample</span>(tt<span class="sc">$</span>tau0,<span class="dv">1000</span>,<span class="at">prob=</span>tt<span class="sc">$</span>scaled.prob),</span>
<span id="cb324-85"><a href="hierarchical-models.html#cb324-85" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">function</span>(x) <span class="fu">posterior</span>(x,school<span class="sc">$</span>sigma2j,school<span class="sc">$</span>yj)[<span class="dv">6</span>,<span class="dv">1</span>])</span>
<span id="cb324-86"><a href="hierarchical-models.html#cb324-86" aria-hidden="true" tabindex="-1"></a>    theta6[<span class="fu">is.nan</span>(theta6)]<span class="ot">&lt;-</span><span class="fu">mean</span>(theta6[<span class="sc">!</span><span class="fu">is.nan</span>(theta6)])</span>
<span id="cb324-87"><a href="hierarchical-models.html#cb324-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb324-88"><a href="hierarchical-models.html#cb324-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb324-89"><a href="hierarchical-models.html#cb324-89" aria-hidden="true" tabindex="-1"></a>  t6q<span class="ot">&lt;-</span><span class="fu">quantile</span>(theta6,<span class="fu">c</span>(<span class="fl">0.025</span>,<span class="fl">0.25</span>,<span class="fl">0.5</span>,<span class="fl">0.75</span>,<span class="fl">0.975</span>),<span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb324-90"><a href="hierarchical-models.html#cb324-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb324-91"><a href="hierarchical-models.html#cb324-91" aria-hidden="true" tabindex="-1"></a>   theta7<span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="fu">sample</span>(tt<span class="sc">$</span>tau0,<span class="dv">1000</span>,<span class="at">prob=</span>tt<span class="sc">$</span>scaled.prob),</span>
<span id="cb324-92"><a href="hierarchical-models.html#cb324-92" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">function</span>(x) <span class="fu">posterior</span>(x,school<span class="sc">$</span>sigma2j,school<span class="sc">$</span>yj)[<span class="dv">7</span>,<span class="dv">1</span>])</span>
<span id="cb324-93"><a href="hierarchical-models.html#cb324-93" aria-hidden="true" tabindex="-1"></a>    theta7[<span class="fu">is.nan</span>(theta7)]<span class="ot">&lt;-</span><span class="fu">mean</span>(theta7[<span class="sc">!</span><span class="fu">is.nan</span>(theta7)])</span>
<span id="cb324-94"><a href="hierarchical-models.html#cb324-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb324-95"><a href="hierarchical-models.html#cb324-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb324-96"><a href="hierarchical-models.html#cb324-96" aria-hidden="true" tabindex="-1"></a>  t7q<span class="ot">&lt;-</span><span class="fu">quantile</span>(theta7,<span class="fu">c</span>(<span class="fl">0.025</span>,<span class="fl">0.25</span>,<span class="fl">0.5</span>,<span class="fl">0.75</span>,<span class="fl">0.975</span>),<span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb324-97"><a href="hierarchical-models.html#cb324-97" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb324-98"><a href="hierarchical-models.html#cb324-98" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb324-99"><a href="hierarchical-models.html#cb324-99" aria-hidden="true" tabindex="-1"></a>   theta8<span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="fu">sample</span>(tt<span class="sc">$</span>tau0,<span class="dv">1000</span>,<span class="at">prob=</span>tt<span class="sc">$</span>scaled.prob),</span>
<span id="cb324-100"><a href="hierarchical-models.html#cb324-100" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">function</span>(x) <span class="fu">posterior</span>(x,school<span class="sc">$</span>sigma2j,school<span class="sc">$</span>yj)[<span class="dv">8</span>,<span class="dv">1</span>])</span>
<span id="cb324-101"><a href="hierarchical-models.html#cb324-101" aria-hidden="true" tabindex="-1"></a>    theta8[<span class="fu">is.nan</span>(theta8)]<span class="ot">&lt;-</span><span class="fu">mean</span>(theta8[<span class="sc">!</span><span class="fu">is.nan</span>(theta8)])</span>
<span id="cb324-102"><a href="hierarchical-models.html#cb324-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb324-103"><a href="hierarchical-models.html#cb324-103" aria-hidden="true" tabindex="-1"></a>  t8q<span class="ot">&lt;-</span><span class="fu">quantile</span>(theta8,<span class="fu">c</span>(<span class="fl">0.025</span>,<span class="fl">0.25</span>,<span class="fl">0.5</span>,<span class="fl">0.75</span>,<span class="fl">0.975</span>),<span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb324-104"><a href="hierarchical-models.html#cb324-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb324-105"><a href="hierarchical-models.html#cb324-105" aria-hidden="true" tabindex="-1"></a> allq<span class="ot">&lt;-</span><span class="fu">rbind</span>(t1q,t2q,t3q,t4q,t5q,t6q,t7q,t8q)</span>
<span id="cb324-106"><a href="hierarchical-models.html#cb324-106" aria-hidden="true" tabindex="-1"></a> <span class="fu">print</span>(allq)</span></code></pre></div>
<pre><code>##            2.5%      25%       50%       75%    97.5%
## t1q   0.4457383 7.326460 10.017273 16.091238 33.37148
## t2q  -3.9503168 4.831116  7.726473 10.619370 20.25554
## t3q -14.8226207 2.859082  6.858540  9.538431 18.57518
## t4q  -7.3115433 5.009563  7.783060 10.934833 21.04213
## t5q  -9.4629862 1.658382  6.024443  8.293584 14.69150
## t6q -10.7831533 2.029477  6.586762  8.797824 17.50866
## t7q   0.9487190 7.244206  9.623687 14.367122 25.85331
## t8q  -7.3113309 4.974897  7.888110 11.282060 27.24911</code></pre>
<ul>
<li><p>i could not figure out how to take the margin across <span class="math inline">\(\mu\)</span> for 5.6 and 5.7.</p></li>
<li><p>we found that our posterior effects had 4<span class="math inline">\(\%\)</span> greater than the maximum observed value 28.4 whereas the text found 22/200 which is slightly larger from 200 simulations, we used 1,000.</p></li>
</ul>
<div class="sourceCode" id="cb326"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb326-1"><a href="hierarchical-models.html#cb326-1" aria-hidden="true" tabindex="-1"></a>  abest<span class="ot">&lt;-</span><span class="fu">table</span>(theta1<span class="sc">&gt;</span>(theta2) <span class="sc">&amp;</span> theta1<span class="sc">&gt;</span>theta3 <span class="sc">&amp;</span> theta1<span class="sc">&gt;</span>theta4 <span class="sc">&amp;</span> theta1<span class="sc">&gt;</span>theta5 <span class="sc">&amp;</span> theta1<span class="sc">&gt;</span>theta6 <span class="sc">&amp;</span> theta1<span class="sc">&gt;</span>theta7 <span class="sc">&amp;</span>theta1<span class="sc">&gt;</span>theta8)</span>
<span id="cb326-2"><a href="hierarchical-models.html#cb326-2" aria-hidden="true" tabindex="-1"></a>  bbest<span class="ot">&lt;-</span><span class="fu">table</span>(theta2<span class="sc">&gt;</span>(theta1) <span class="sc">&amp;</span> theta2<span class="sc">&gt;</span>theta3 <span class="sc">&amp;</span> theta2<span class="sc">&gt;</span>theta4 <span class="sc">&amp;</span> theta2<span class="sc">&gt;</span>theta5 <span class="sc">&amp;</span> theta2<span class="sc">&gt;</span>theta6 <span class="sc">&amp;</span> theta2<span class="sc">&gt;</span>theta7 <span class="sc">&amp;</span>theta2<span class="sc">&gt;</span>theta8)</span>
<span id="cb326-3"><a href="hierarchical-models.html#cb326-3" aria-hidden="true" tabindex="-1"></a>  cbest<span class="ot">&lt;-</span><span class="fu">table</span>(theta3<span class="sc">&gt;</span>(theta1) <span class="sc">&amp;</span> theta3<span class="sc">&gt;</span>theta2 <span class="sc">&amp;</span> theta3<span class="sc">&gt;</span>theta4 <span class="sc">&amp;</span> theta3<span class="sc">&gt;</span>theta5 <span class="sc">&amp;</span> theta3<span class="sc">&gt;</span>theta6 <span class="sc">&amp;</span> theta3<span class="sc">&gt;</span>theta7 <span class="sc">&amp;</span>theta3<span class="sc">&gt;</span>theta8)</span>
<span id="cb326-4"><a href="hierarchical-models.html#cb326-4" aria-hidden="true" tabindex="-1"></a>  dbest<span class="ot">&lt;-</span><span class="fu">table</span>(theta4<span class="sc">&gt;</span>(theta1) <span class="sc">&amp;</span> theta4<span class="sc">&gt;</span>theta2 <span class="sc">&amp;</span> theta4<span class="sc">&gt;</span>theta3 <span class="sc">&amp;</span> theta4<span class="sc">&gt;</span>theta5 <span class="sc">&amp;</span> theta4<span class="sc">&gt;</span>theta6 <span class="sc">&amp;</span> theta4<span class="sc">&gt;</span>theta7 <span class="sc">&amp;</span>theta4<span class="sc">&gt;</span>theta8)</span>
<span id="cb326-5"><a href="hierarchical-models.html#cb326-5" aria-hidden="true" tabindex="-1"></a>  ebest<span class="ot">&lt;-</span><span class="fu">table</span>(theta5<span class="sc">&gt;</span>(theta1) <span class="sc">&amp;</span> theta5<span class="sc">&gt;</span>theta2 <span class="sc">&amp;</span> theta5<span class="sc">&gt;</span>theta3 <span class="sc">&amp;</span> theta5<span class="sc">&gt;</span>theta4 <span class="sc">&amp;</span> theta5<span class="sc">&gt;</span>theta6 <span class="sc">&amp;</span> theta5<span class="sc">&gt;</span>theta7 <span class="sc">&amp;</span>theta5<span class="sc">&gt;</span>theta8)</span>
<span id="cb326-6"><a href="hierarchical-models.html#cb326-6" aria-hidden="true" tabindex="-1"></a>  fbest<span class="ot">&lt;-</span><span class="fu">table</span>(theta6<span class="sc">&gt;</span>(theta1) <span class="sc">&amp;</span> theta6<span class="sc">&gt;</span>theta2 <span class="sc">&amp;</span> theta6<span class="sc">&gt;</span>theta3 <span class="sc">&amp;</span> theta6<span class="sc">&gt;</span>theta4 <span class="sc">&amp;</span> theta6<span class="sc">&gt;</span>theta5 <span class="sc">&amp;</span> theta6<span class="sc">&gt;</span>theta7 <span class="sc">&amp;</span>theta6<span class="sc">&gt;</span>theta8)</span>
<span id="cb326-7"><a href="hierarchical-models.html#cb326-7" aria-hidden="true" tabindex="-1"></a>  gbest<span class="ot">&lt;-</span><span class="fu">table</span>(theta7<span class="sc">&gt;</span>(theta1) <span class="sc">&amp;</span> theta7<span class="sc">&gt;</span>theta2 <span class="sc">&amp;</span> theta7<span class="sc">&gt;</span>theta3 <span class="sc">&amp;</span> theta7<span class="sc">&gt;</span>theta4 <span class="sc">&amp;</span> theta7<span class="sc">&gt;</span>theta6 <span class="sc">&amp;</span> theta7<span class="sc">&gt;</span>theta6 <span class="sc">&amp;</span>theta7<span class="sc">&gt;</span>theta8)</span>
<span id="cb326-8"><a href="hierarchical-models.html#cb326-8" aria-hidden="true" tabindex="-1"></a>  hbest<span class="ot">&lt;-</span><span class="fu">table</span>(theta8<span class="sc">&gt;</span>(theta1) <span class="sc">&amp;</span> theta8<span class="sc">&gt;</span>theta2 <span class="sc">&amp;</span> theta8<span class="sc">&gt;</span>theta3 <span class="sc">&amp;</span> theta8<span class="sc">&gt;</span>theta4 <span class="sc">&amp;</span> theta8<span class="sc">&gt;</span>theta5 <span class="sc">&amp;</span> theta8<span class="sc">&gt;</span>theta6 <span class="sc">&amp;</span>theta8<span class="sc">&gt;</span>theta7)</span>
<span id="cb326-9"><a href="hierarchical-models.html#cb326-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb326-10"><a href="hierarchical-models.html#cb326-10" aria-hidden="true" tabindex="-1"></a>  a<span class="ot">&lt;-</span>abest[<span class="st">&#39;TRUE&#39;</span>]<span class="sc">/</span><span class="fu">sum</span>(abest)</span>
<span id="cb326-11"><a href="hierarchical-models.html#cb326-11" aria-hidden="true" tabindex="-1"></a>  b<span class="ot">&lt;-</span>bbest[<span class="st">&#39;TRUE&#39;</span>]<span class="sc">/</span><span class="fu">sum</span>(bbest)</span>
<span id="cb326-12"><a href="hierarchical-models.html#cb326-12" aria-hidden="true" tabindex="-1"></a>  c<span class="ot">&lt;-</span>cbest[<span class="st">&#39;TRUE&#39;</span>]<span class="sc">/</span><span class="fu">sum</span>(cbest)</span>
<span id="cb326-13"><a href="hierarchical-models.html#cb326-13" aria-hidden="true" tabindex="-1"></a>  d<span class="ot">&lt;-</span>dbest[<span class="st">&#39;TRUE&#39;</span>]<span class="sc">/</span><span class="fu">sum</span>(dbest)</span>
<span id="cb326-14"><a href="hierarchical-models.html#cb326-14" aria-hidden="true" tabindex="-1"></a>  e<span class="ot">&lt;-</span>ebest[<span class="st">&#39;TRUE&#39;</span>]<span class="sc">/</span><span class="fu">sum</span>(ebest)</span>
<span id="cb326-15"><a href="hierarchical-models.html#cb326-15" aria-hidden="true" tabindex="-1"></a>  f<span class="ot">&lt;-</span>fbest[<span class="st">&#39;TRUE&#39;</span>]<span class="sc">/</span><span class="fu">sum</span>(fbest)</span>
<span id="cb326-16"><a href="hierarchical-models.html#cb326-16" aria-hidden="true" tabindex="-1"></a>  g<span class="ot">&lt;-</span>gbest[<span class="st">&#39;TRUE&#39;</span>]<span class="sc">/</span><span class="fu">sum</span>(gbest)</span>
<span id="cb326-17"><a href="hierarchical-models.html#cb326-17" aria-hidden="true" tabindex="-1"></a>  h<span class="ot">&lt;-</span>hbest[<span class="st">&#39;TRUE&#39;</span>]<span class="sc">/</span><span class="fu">sum</span>(hbest)</span></code></pre></div>
<div id="q3-part-a" class="section level4 hasAnchor" number="5.3.0.1">
<h4><span class="header-section-number">5.3.0.1</span> Q3 part a<a href="hierarchical-models.html#q3-part-a" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<ul>
<li>5.3a this is correct and is very close to section 5 results.</li>
</ul>
<div class="sourceCode" id="cb327"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb327-1"><a href="hierarchical-models.html#cb327-1" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">matrix</span>(<span class="dv">0</span>,<span class="at">nrow=</span><span class="dv">8</span>,<span class="at">ncol=</span><span class="dv">8</span>)</span>
<span id="cb327-2"><a href="hierarchical-models.html#cb327-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb327-3"><a href="hierarchical-models.html#cb327-3" aria-hidden="true" tabindex="-1"></a>  fillIn<span class="ot">&lt;-</span><span class="cf">function</span>(better,theta1,theta2,<span class="at">i=</span><span class="dv">1</span>,<span class="at">j=</span><span class="dv">2</span>){</span>
<span id="cb327-4"><a href="hierarchical-models.html#cb327-4" aria-hidden="true" tabindex="-1"></a>   pij<span class="ot">&lt;-</span><span class="fu">table</span>(theta1<span class="sc">&gt;</span>theta2)<span class="sc">/</span><span class="fu">sum</span>(<span class="fu">table</span>(theta1<span class="sc">&gt;</span>theta2))</span>
<span id="cb327-5"><a href="hierarchical-models.html#cb327-5" aria-hidden="true" tabindex="-1"></a>   better[i,j]<span class="ot">&lt;-</span>pij[<span class="st">&#39;TRUE&#39;</span>]</span>
<span id="cb327-6"><a href="hierarchical-models.html#cb327-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(better)</span>
<span id="cb327-7"><a href="hierarchical-models.html#cb327-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb327-8"><a href="hierarchical-models.html#cb327-8" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta1,theta2,<span class="at">i=</span><span class="dv">1</span>,<span class="at">j=</span><span class="dv">2</span>)</span>
<span id="cb327-9"><a href="hierarchical-models.html#cb327-9" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta1,theta3,<span class="at">i=</span><span class="dv">1</span>,<span class="at">j=</span><span class="dv">3</span>)</span>
<span id="cb327-10"><a href="hierarchical-models.html#cb327-10" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta1,theta4,<span class="at">i=</span><span class="dv">1</span>,<span class="at">j=</span><span class="dv">4</span>)</span>
<span id="cb327-11"><a href="hierarchical-models.html#cb327-11" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta1,theta5,<span class="at">i=</span><span class="dv">1</span>,<span class="at">j=</span><span class="dv">5</span>)</span>
<span id="cb327-12"><a href="hierarchical-models.html#cb327-12" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta1,theta6,<span class="at">i=</span><span class="dv">1</span>,<span class="at">j=</span><span class="dv">6</span>)</span>
<span id="cb327-13"><a href="hierarchical-models.html#cb327-13" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta1,theta7,<span class="at">i=</span><span class="dv">1</span>,<span class="at">j=</span><span class="dv">7</span>)</span>
<span id="cb327-14"><a href="hierarchical-models.html#cb327-14" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta1,theta8,<span class="at">i=</span><span class="dv">1</span>,<span class="at">j=</span><span class="dv">8</span>)</span>
<span id="cb327-15"><a href="hierarchical-models.html#cb327-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb327-16"><a href="hierarchical-models.html#cb327-16" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta2,theta1,<span class="at">i=</span><span class="dv">2</span>,<span class="at">j=</span><span class="dv">1</span>)</span>
<span id="cb327-17"><a href="hierarchical-models.html#cb327-17" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta2,theta3,<span class="at">i=</span><span class="dv">2</span>,<span class="at">j=</span><span class="dv">3</span>)</span>
<span id="cb327-18"><a href="hierarchical-models.html#cb327-18" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta2,theta4,<span class="at">i=</span><span class="dv">2</span>,<span class="at">j=</span><span class="dv">4</span>)</span>
<span id="cb327-19"><a href="hierarchical-models.html#cb327-19" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta2,theta5,<span class="at">i=</span><span class="dv">2</span>,<span class="at">j=</span><span class="dv">5</span>)</span>
<span id="cb327-20"><a href="hierarchical-models.html#cb327-20" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta2,theta6,<span class="at">i=</span><span class="dv">2</span>,<span class="at">j=</span><span class="dv">6</span>)</span>
<span id="cb327-21"><a href="hierarchical-models.html#cb327-21" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta2,theta7,<span class="at">i=</span><span class="dv">2</span>,<span class="at">j=</span><span class="dv">7</span>)</span>
<span id="cb327-22"><a href="hierarchical-models.html#cb327-22" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta2,theta8,<span class="at">i=</span><span class="dv">2</span>,<span class="at">j=</span><span class="dv">8</span>)</span>
<span id="cb327-23"><a href="hierarchical-models.html#cb327-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb327-24"><a href="hierarchical-models.html#cb327-24" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta3,theta1,<span class="at">i=</span><span class="dv">3</span>,<span class="at">j=</span><span class="dv">1</span>)</span>
<span id="cb327-25"><a href="hierarchical-models.html#cb327-25" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta3,theta2,<span class="at">i=</span><span class="dv">3</span>,<span class="at">j=</span><span class="dv">2</span>)</span>
<span id="cb327-26"><a href="hierarchical-models.html#cb327-26" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta3,theta4,<span class="at">i=</span><span class="dv">3</span>,<span class="at">j=</span><span class="dv">4</span>)</span>
<span id="cb327-27"><a href="hierarchical-models.html#cb327-27" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta3,theta5,<span class="at">i=</span><span class="dv">3</span>,<span class="at">j=</span><span class="dv">5</span>)</span>
<span id="cb327-28"><a href="hierarchical-models.html#cb327-28" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta3,theta6,<span class="at">i=</span><span class="dv">3</span>,<span class="at">j=</span><span class="dv">6</span>)</span>
<span id="cb327-29"><a href="hierarchical-models.html#cb327-29" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta3,theta7,<span class="at">i=</span><span class="dv">3</span>,<span class="at">j=</span><span class="dv">7</span>)</span>
<span id="cb327-30"><a href="hierarchical-models.html#cb327-30" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta3,theta8,<span class="at">i=</span><span class="dv">3</span>,<span class="at">j=</span><span class="dv">8</span>)</span>
<span id="cb327-31"><a href="hierarchical-models.html#cb327-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb327-32"><a href="hierarchical-models.html#cb327-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb327-33"><a href="hierarchical-models.html#cb327-33" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta4,theta1,<span class="at">i=</span><span class="dv">4</span>,<span class="at">j=</span><span class="dv">1</span>)</span>
<span id="cb327-34"><a href="hierarchical-models.html#cb327-34" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta4,theta2,<span class="at">i=</span><span class="dv">4</span>,<span class="at">j=</span><span class="dv">2</span>)</span>
<span id="cb327-35"><a href="hierarchical-models.html#cb327-35" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta4,theta3,<span class="at">i=</span><span class="dv">4</span>,<span class="at">j=</span><span class="dv">3</span>)</span>
<span id="cb327-36"><a href="hierarchical-models.html#cb327-36" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta4,theta5,<span class="at">i=</span><span class="dv">4</span>,<span class="at">j=</span><span class="dv">5</span>)</span>
<span id="cb327-37"><a href="hierarchical-models.html#cb327-37" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta4,theta6,<span class="at">i=</span><span class="dv">4</span>,<span class="at">j=</span><span class="dv">6</span>)</span>
<span id="cb327-38"><a href="hierarchical-models.html#cb327-38" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta4,theta7,<span class="at">i=</span><span class="dv">4</span>,<span class="at">j=</span><span class="dv">7</span>)</span>
<span id="cb327-39"><a href="hierarchical-models.html#cb327-39" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta4,theta8,<span class="at">i=</span><span class="dv">4</span>,<span class="at">j=</span><span class="dv">8</span>)</span>
<span id="cb327-40"><a href="hierarchical-models.html#cb327-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb327-41"><a href="hierarchical-models.html#cb327-41" aria-hidden="true" tabindex="-1"></a>   better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta5,theta1,<span class="at">i=</span><span class="dv">5</span>,<span class="at">j=</span><span class="dv">1</span>)</span>
<span id="cb327-42"><a href="hierarchical-models.html#cb327-42" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta5,theta2,<span class="at">i=</span><span class="dv">5</span>,<span class="at">j=</span><span class="dv">2</span>)</span>
<span id="cb327-43"><a href="hierarchical-models.html#cb327-43" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta5,theta3,<span class="at">i=</span><span class="dv">5</span>,<span class="at">j=</span><span class="dv">3</span>)</span>
<span id="cb327-44"><a href="hierarchical-models.html#cb327-44" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta5,theta4,<span class="at">i=</span><span class="dv">5</span>,<span class="at">j=</span><span class="dv">4</span>)</span>
<span id="cb327-45"><a href="hierarchical-models.html#cb327-45" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta5,theta6,<span class="at">i=</span><span class="dv">5</span>,<span class="at">j=</span><span class="dv">6</span>)</span>
<span id="cb327-46"><a href="hierarchical-models.html#cb327-46" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta5,theta7,<span class="at">i=</span><span class="dv">5</span>,<span class="at">j=</span><span class="dv">7</span>)</span>
<span id="cb327-47"><a href="hierarchical-models.html#cb327-47" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta5,theta8,<span class="at">i=</span><span class="dv">5</span>,<span class="at">j=</span><span class="dv">8</span>)</span>
<span id="cb327-48"><a href="hierarchical-models.html#cb327-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb327-49"><a href="hierarchical-models.html#cb327-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb327-50"><a href="hierarchical-models.html#cb327-50" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta6,theta1,<span class="at">i=</span><span class="dv">6</span>,<span class="at">j=</span><span class="dv">1</span>)</span>
<span id="cb327-51"><a href="hierarchical-models.html#cb327-51" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta6,theta2,<span class="at">i=</span><span class="dv">6</span>,<span class="at">j=</span><span class="dv">2</span>)</span>
<span id="cb327-52"><a href="hierarchical-models.html#cb327-52" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta6,theta3,<span class="at">i=</span><span class="dv">6</span>,<span class="at">j=</span><span class="dv">3</span>)</span>
<span id="cb327-53"><a href="hierarchical-models.html#cb327-53" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta6,theta4,<span class="at">i=</span><span class="dv">6</span>,<span class="at">j=</span><span class="dv">4</span>)</span>
<span id="cb327-54"><a href="hierarchical-models.html#cb327-54" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta6,theta5,<span class="at">i=</span><span class="dv">6</span>,<span class="at">j=</span><span class="dv">5</span>)</span>
<span id="cb327-55"><a href="hierarchical-models.html#cb327-55" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta6,theta7,<span class="at">i=</span><span class="dv">6</span>,<span class="at">j=</span><span class="dv">7</span>)</span>
<span id="cb327-56"><a href="hierarchical-models.html#cb327-56" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta6,theta8,<span class="at">i=</span><span class="dv">6</span>,<span class="at">j=</span><span class="dv">8</span>)</span>
<span id="cb327-57"><a href="hierarchical-models.html#cb327-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb327-58"><a href="hierarchical-models.html#cb327-58" aria-hidden="true" tabindex="-1"></a>    better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta7,theta1,<span class="at">i=</span><span class="dv">7</span>,<span class="at">j=</span><span class="dv">1</span>)</span>
<span id="cb327-59"><a href="hierarchical-models.html#cb327-59" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta7,theta2,<span class="at">i=</span><span class="dv">7</span>,<span class="at">j=</span><span class="dv">2</span>)</span>
<span id="cb327-60"><a href="hierarchical-models.html#cb327-60" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta7,theta3,<span class="at">i=</span><span class="dv">7</span>,<span class="at">j=</span><span class="dv">3</span>)</span>
<span id="cb327-61"><a href="hierarchical-models.html#cb327-61" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta7,theta4,<span class="at">i=</span><span class="dv">7</span>,<span class="at">j=</span><span class="dv">4</span>)</span>
<span id="cb327-62"><a href="hierarchical-models.html#cb327-62" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta7,theta5,<span class="at">i=</span><span class="dv">7</span>,<span class="at">j=</span><span class="dv">5</span>)</span>
<span id="cb327-63"><a href="hierarchical-models.html#cb327-63" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta7,theta6,<span class="at">i=</span><span class="dv">7</span>,<span class="at">j=</span><span class="dv">6</span>)</span>
<span id="cb327-64"><a href="hierarchical-models.html#cb327-64" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta7,theta8,<span class="at">i=</span><span class="dv">7</span>,<span class="at">j=</span><span class="dv">8</span>)</span>
<span id="cb327-65"><a href="hierarchical-models.html#cb327-65" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb327-66"><a href="hierarchical-models.html#cb327-66" aria-hidden="true" tabindex="-1"></a>   better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta8,theta1,<span class="at">i=</span><span class="dv">8</span>,<span class="at">j=</span><span class="dv">1</span>)</span>
<span id="cb327-67"><a href="hierarchical-models.html#cb327-67" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta8,theta2,<span class="at">i=</span><span class="dv">8</span>,<span class="at">j=</span><span class="dv">2</span>)</span>
<span id="cb327-68"><a href="hierarchical-models.html#cb327-68" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta8,theta3,<span class="at">i=</span><span class="dv">8</span>,<span class="at">j=</span><span class="dv">3</span>)</span>
<span id="cb327-69"><a href="hierarchical-models.html#cb327-69" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta8,theta4,<span class="at">i=</span><span class="dv">8</span>,<span class="at">j=</span><span class="dv">4</span>)</span>
<span id="cb327-70"><a href="hierarchical-models.html#cb327-70" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta8,theta5,<span class="at">i=</span><span class="dv">8</span>,<span class="at">j=</span><span class="dv">5</span>)</span>
<span id="cb327-71"><a href="hierarchical-models.html#cb327-71" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta8,theta6,<span class="at">i=</span><span class="dv">8</span>,<span class="at">j=</span><span class="dv">6</span>)</span>
<span id="cb327-72"><a href="hierarchical-models.html#cb327-72" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">fillIn</span>(better,theta8,theta7,<span class="at">i=</span><span class="dv">8</span>,<span class="at">j=</span><span class="dv">7</span>)</span>
<span id="cb327-73"><a href="hierarchical-models.html#cb327-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb327-74"><a href="hierarchical-models.html#cb327-74" aria-hidden="true" tabindex="-1"></a>  better<span class="ot">&lt;-</span><span class="fu">cbind</span>(<span class="fu">c</span>(a,b,c,d,e,f,g,h),better)</span>
<span id="cb327-75"><a href="hierarchical-models.html#cb327-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(better)<span class="ot">&lt;-</span>LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>]</span>
<span id="cb327-76"><a href="hierarchical-models.html#cb327-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(better)<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">&quot;best&quot;</span>,LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>])</span>
<span id="cb327-77"><a href="hierarchical-models.html#cb327-77" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb327-78"><a href="hierarchical-models.html#cb327-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(better)</span></code></pre></div>
<pre><code>##    best     A     B     C     D     E     F     G     H
## A 0.290 0.000 0.671 0.714 0.662 0.783 0.752 0.533 0.633
## B 0.102 0.329 0.000 0.570 0.503 0.634 0.620 0.343 0.487
## C 0.074 0.286 0.430 0.000 0.425 0.556 0.526 0.306 0.417
## D 0.100 0.338 0.497 0.575 0.000 0.636 0.601 0.358 0.482
## E 0.040 0.217 0.366 0.444 0.364 0.000 0.467 0.220 0.346
## F 0.047 0.248 0.380 0.474 0.399 0.533 0.000 0.249 0.377
## G 0.229 0.467 0.657 0.694 0.642 0.780 0.751 0.000 0.609
## H 0.124 0.367 0.513 0.583 0.518 0.654 0.623 0.391 0.000</code></pre>
<p>Inference on the <span class="math inline">\(P(max(\theta_j)&gt;28.4)\)</span> in our data is 93/1000 which is 0.093. from the text 22/200 which is roughly 0.11</p>
<div class="sourceCode" id="cb329"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb329-1"><a href="hierarchical-models.html#cb329-1" aria-hidden="true" tabindex="-1"></a>theta<span class="ot">&lt;-</span><span class="fu">data.frame</span>(theta1,theta2,theta3,theta4,theta5,theta6,theta7,theta8)</span>
<span id="cb329-2"><a href="hierarchical-models.html#cb329-2" aria-hidden="true" tabindex="-1"></a> <span class="fu">hist</span>(<span class="fu">apply</span>(theta,<span class="dv">1</span>,max),<span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">60</span>),<span class="at">main=</span><span class="st">&#39;Figure 5.8b max(theta j)&#39;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-68-1.png" width="672" /></p>
<div class="sourceCode" id="cb330"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb330-1"><a href="hierarchical-models.html#cb330-1" aria-hidden="true" tabindex="-1"></a> <span class="fu">table</span>(<span class="fu">apply</span>(theta,<span class="dv">1</span>,max)<span class="sc">&gt;</span><span class="fl">28.4</span>)[<span class="st">&#39;TRUE&#39;</span>]<span class="sc">/</span><span class="fu">sum</span>(<span class="fu">table</span>(<span class="fu">apply</span>(theta,<span class="dv">1</span>,max)<span class="sc">&gt;</span><span class="fl">28.4</span>))</span></code></pre></div>
<pre><code>##  TRUE 
## 0.088</code></pre>
</div>
<div id="q-5.3-part-b" class="section level4 hasAnchor" number="5.3.0.2">
<h4><span class="header-section-number">5.3.0.2</span> Q 5.3 part b<a href="hierarchical-models.html#q-5.3-part-b" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<ul>
<li>5.3.b
taking <span class="math inline">\(\tau \to \infty\)</span> we have <span class="math inline">\(\theta_j \sim N(y_j, \sigma^2_j)\)</span></li>
</ul>
<p>For $P(_i &gt; _j) = <span class="math inline">\(P(\theta_i - \theta_j&gt;0\)</span>)</p>
<div class="sourceCode" id="cb332"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb332-1"><a href="hierarchical-models.html#cb332-1" aria-hidden="true" tabindex="-1"></a>  x1<span class="ot">&lt;-</span><span class="fu">rnorm</span>(<span class="dv">1000</span>,<span class="at">mean=</span>school<span class="sc">$</span>yj[<span class="dv">1</span>],<span class="at">sd=</span>school<span class="sc">$</span>sigmaj[<span class="dv">1</span>])</span>
<span id="cb332-2"><a href="hierarchical-models.html#cb332-2" aria-hidden="true" tabindex="-1"></a>  x2<span class="ot">&lt;-</span><span class="fu">rnorm</span>(<span class="dv">1000</span>,<span class="at">mean=</span>school<span class="sc">$</span>yj[<span class="dv">2</span>],<span class="at">sd=</span>school<span class="sc">$</span>sigmaj[<span class="dv">2</span>])</span>
<span id="cb332-3"><a href="hierarchical-models.html#cb332-3" aria-hidden="true" tabindex="-1"></a>  x3<span class="ot">&lt;-</span><span class="fu">rnorm</span>(<span class="dv">1000</span>,<span class="at">mean=</span>school<span class="sc">$</span>yj[<span class="dv">3</span>],<span class="at">sd=</span>school<span class="sc">$</span>sigmaj[<span class="dv">3</span>])</span>
<span id="cb332-4"><a href="hierarchical-models.html#cb332-4" aria-hidden="true" tabindex="-1"></a>  x4<span class="ot">&lt;-</span><span class="fu">rnorm</span>(<span class="dv">1000</span>,<span class="at">mean=</span>school<span class="sc">$</span>yj[<span class="dv">4</span>],<span class="at">sd=</span>school<span class="sc">$</span>sigmaj[<span class="dv">4</span>])</span>
<span id="cb332-5"><a href="hierarchical-models.html#cb332-5" aria-hidden="true" tabindex="-1"></a>  x5<span class="ot">&lt;-</span><span class="fu">rnorm</span>(<span class="dv">1000</span>,<span class="at">mean=</span>school<span class="sc">$</span>yj[<span class="dv">5</span>],<span class="at">sd=</span>school<span class="sc">$</span>sigmaj[<span class="dv">5</span>])</span>
<span id="cb332-6"><a href="hierarchical-models.html#cb332-6" aria-hidden="true" tabindex="-1"></a>  x6<span class="ot">&lt;-</span><span class="fu">rnorm</span>(<span class="dv">1000</span>,<span class="at">mean=</span>school<span class="sc">$</span>yj[<span class="dv">6</span>],<span class="at">sd=</span>school<span class="sc">$</span>sigmaj[<span class="dv">6</span>])</span>
<span id="cb332-7"><a href="hierarchical-models.html#cb332-7" aria-hidden="true" tabindex="-1"></a>  x7<span class="ot">&lt;-</span><span class="fu">rnorm</span>(<span class="dv">1000</span>,<span class="at">mean=</span>school<span class="sc">$</span>yj[<span class="dv">7</span>],<span class="at">sd=</span>school<span class="sc">$</span>sigmaj[<span class="dv">7</span>])</span>
<span id="cb332-8"><a href="hierarchical-models.html#cb332-8" aria-hidden="true" tabindex="-1"></a>  x8<span class="ot">&lt;-</span><span class="fu">rnorm</span>(<span class="dv">1000</span>,<span class="at">mean=</span>school<span class="sc">$</span>yj[<span class="dv">8</span>],<span class="at">sd=</span>school<span class="sc">$</span>sigmaj[<span class="dv">8</span>])</span>
<span id="cb332-9"><a href="hierarchical-models.html#cb332-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb332-10"><a href="hierarchical-models.html#cb332-10" aria-hidden="true" tabindex="-1"></a>  allQ<span class="ot">&lt;-</span><span class="fu">rbind</span>(  <span class="fu">quantile</span>(x1,<span class="fu">c</span>(<span class="fl">0.025</span>,<span class="fl">0.25</span>,<span class="fl">0.5</span>,<span class="fl">0.75</span>,<span class="fl">0.975</span>)),</span>
<span id="cb332-11"><a href="hierarchical-models.html#cb332-11" aria-hidden="true" tabindex="-1"></a>                <span class="fu">quantile</span>(x2,<span class="fu">c</span>(<span class="fl">0.025</span>,<span class="fl">0.25</span>,<span class="fl">0.5</span>,<span class="fl">0.75</span>,<span class="fl">0.975</span>)),</span>
<span id="cb332-12"><a href="hierarchical-models.html#cb332-12" aria-hidden="true" tabindex="-1"></a>                <span class="fu">quantile</span>(x3,<span class="fu">c</span>(<span class="fl">0.025</span>,<span class="fl">0.25</span>,<span class="fl">0.5</span>,<span class="fl">0.75</span>,<span class="fl">0.975</span>)),</span>
<span id="cb332-13"><a href="hierarchical-models.html#cb332-13" aria-hidden="true" tabindex="-1"></a>                <span class="fu">quantile</span>(x4,<span class="fu">c</span>(<span class="fl">0.025</span>,<span class="fl">0.25</span>,<span class="fl">0.5</span>,<span class="fl">0.75</span>,<span class="fl">0.975</span>)),</span>
<span id="cb332-14"><a href="hierarchical-models.html#cb332-14" aria-hidden="true" tabindex="-1"></a>                <span class="fu">quantile</span>(x5,<span class="fu">c</span>(<span class="fl">0.025</span>,<span class="fl">0.25</span>,<span class="fl">0.5</span>,<span class="fl">0.75</span>,<span class="fl">0.975</span>)),</span>
<span id="cb332-15"><a href="hierarchical-models.html#cb332-15" aria-hidden="true" tabindex="-1"></a>                <span class="fu">quantile</span>(x6,<span class="fu">c</span>(<span class="fl">0.025</span>,<span class="fl">0.25</span>,<span class="fl">0.5</span>,<span class="fl">0.75</span>,<span class="fl">0.975</span>)),</span>
<span id="cb332-16"><a href="hierarchical-models.html#cb332-16" aria-hidden="true" tabindex="-1"></a>                <span class="fu">quantile</span>(x7,<span class="fu">c</span>(<span class="fl">0.025</span>,<span class="fl">0.25</span>,<span class="fl">0.5</span>,<span class="fl">0.75</span>,<span class="fl">0.975</span>)),</span>
<span id="cb332-17"><a href="hierarchical-models.html#cb332-17" aria-hidden="true" tabindex="-1"></a>                <span class="fu">quantile</span>(x8,<span class="fu">c</span>(<span class="fl">0.025</span>,<span class="fl">0.25</span>,<span class="fl">0.5</span>,<span class="fl">0.75</span>,<span class="fl">0.975</span>))</span>
<span id="cb332-18"><a href="hierarchical-models.html#cb332-18" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb332-19"><a href="hierarchical-models.html#cb332-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(allQ)<span class="ot">&lt;-</span>LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>]</span>
<span id="cb332-20"><a href="hierarchical-models.html#cb332-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb332-21"><a href="hierarchical-models.html#cb332-21" aria-hidden="true" tabindex="-1"></a>  <span class="do">## pair wise </span></span>
<span id="cb332-22"><a href="hierarchical-models.html#cb332-22" aria-hidden="true" tabindex="-1"></a>  better2<span class="ot">&lt;-</span><span class="fu">matrix</span>(<span class="dv">0</span>,<span class="at">nrow=</span><span class="dv">8</span>,<span class="at">ncol=</span><span class="dv">8</span>)</span>
<span id="cb332-23"><a href="hierarchical-models.html#cb332-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>){</span>
<span id="cb332-24"><a href="hierarchical-models.html#cb332-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>){</span>
<span id="cb332-25"><a href="hierarchical-models.html#cb332-25" aria-hidden="true" tabindex="-1"></a>    better2[i,j]<span class="ot">&lt;-</span> <span class="fu">pnorm</span>( (school<span class="sc">$</span>yj[i]<span class="sc">-</span> school<span class="sc">$</span>yj[j])<span class="sc">/</span><span class="fu">sqrt</span>( school<span class="sc">$</span>sigma2j[i]<span class="sc">+</span>school<span class="sc">$</span>sigma2j[j]) ) </span>
<span id="cb332-26"><a href="hierarchical-models.html#cb332-26" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb332-27"><a href="hierarchical-models.html#cb332-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb332-28"><a href="hierarchical-models.html#cb332-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb332-29"><a href="hierarchical-models.html#cb332-29" aria-hidden="true" tabindex="-1"></a> allind<span class="ot">&lt;-</span><span class="fu">cbind</span>(x1,x2,x3,x4,x5,x6,x7,x8)</span>
<span id="cb332-30"><a href="hierarchical-models.html#cb332-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb332-31"><a href="hierarchical-models.html#cb332-31" aria-hidden="true" tabindex="-1"></a>  x1b<span class="ot">&lt;-</span><span class="fu">table</span>(x1<span class="sc">&gt;=</span><span class="fu">apply</span>(allind,<span class="dv">1</span>,max))[<span class="st">&#39;TRUE&#39;</span>]<span class="sc">/</span><span class="dv">1000</span></span>
<span id="cb332-32"><a href="hierarchical-models.html#cb332-32" aria-hidden="true" tabindex="-1"></a>  x2b<span class="ot">&lt;-</span><span class="fu">table</span>(x2<span class="sc">&gt;=</span><span class="fu">apply</span>(allind,<span class="dv">1</span>,max))[<span class="st">&#39;TRUE&#39;</span>]<span class="sc">/</span><span class="dv">1000</span></span>
<span id="cb332-33"><a href="hierarchical-models.html#cb332-33" aria-hidden="true" tabindex="-1"></a>  x3b<span class="ot">&lt;-</span><span class="fu">table</span>(x3<span class="sc">&gt;=</span><span class="fu">apply</span>(allind,<span class="dv">1</span>,max))[<span class="st">&#39;TRUE&#39;</span>]<span class="sc">/</span><span class="dv">1000</span></span>
<span id="cb332-34"><a href="hierarchical-models.html#cb332-34" aria-hidden="true" tabindex="-1"></a>  x4b<span class="ot">&lt;-</span><span class="fu">table</span>(x4<span class="sc">&gt;=</span><span class="fu">apply</span>(allind,<span class="dv">1</span>,max))[<span class="st">&#39;TRUE&#39;</span>]<span class="sc">/</span><span class="dv">1000</span></span>
<span id="cb332-35"><a href="hierarchical-models.html#cb332-35" aria-hidden="true" tabindex="-1"></a>  x5b<span class="ot">&lt;-</span><span class="fu">table</span>(x5<span class="sc">&gt;=</span><span class="fu">apply</span>(allind,<span class="dv">1</span>,max))[<span class="st">&#39;TRUE&#39;</span>]<span class="sc">/</span><span class="dv">1000</span></span>
<span id="cb332-36"><a href="hierarchical-models.html#cb332-36" aria-hidden="true" tabindex="-1"></a>  x6b<span class="ot">&lt;-</span><span class="fu">table</span>(x6<span class="sc">&gt;=</span><span class="fu">apply</span>(allind,<span class="dv">1</span>,max))[<span class="st">&#39;TRUE&#39;</span>]<span class="sc">/</span><span class="dv">1000</span></span>
<span id="cb332-37"><a href="hierarchical-models.html#cb332-37" aria-hidden="true" tabindex="-1"></a>  x7b<span class="ot">&lt;-</span><span class="fu">table</span>(x7<span class="sc">&gt;=</span><span class="fu">apply</span>(allind,<span class="dv">1</span>,max))[<span class="st">&#39;TRUE&#39;</span>]<span class="sc">/</span><span class="dv">1000</span></span>
<span id="cb332-38"><a href="hierarchical-models.html#cb332-38" aria-hidden="true" tabindex="-1"></a>  x8b<span class="ot">&lt;-</span><span class="fu">table</span>(x8<span class="sc">&gt;=</span><span class="fu">apply</span>(allind,<span class="dv">1</span>,max))[<span class="st">&#39;TRUE&#39;</span>]<span class="sc">/</span><span class="dv">1000</span></span>
<span id="cb332-39"><a href="hierarchical-models.html#cb332-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb332-40"><a href="hierarchical-models.html#cb332-40" aria-hidden="true" tabindex="-1"></a>  sep.prob<span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="fu">c</span>(x1b,x2b,x3b,x4b,x5b,x6b,x7b,x8b),better2)</span>
<span id="cb332-41"><a href="hierarchical-models.html#cb332-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(sep.prob)<span class="ot">&lt;-</span>LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>]</span>
<span id="cb332-42"><a href="hierarchical-models.html#cb332-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(sep.prob)<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">&quot;best&quot;</span>,LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>])</span>
<span id="cb332-43"><a href="hierarchical-models.html#cb332-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb332-44"><a href="hierarchical-models.html#cb332-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(sep.prob)</span></code></pre></div>
<pre><code>##    best          A         B         C         D         E         F          G
## A 0.554 0.50000000 0.8663713 0.9212424 0.8705441 0.9513231 0.9266837 0.71045013
## B 0.034 0.13362875 0.5000000 0.7200530 0.5268155 0.7482410 0.6811336 0.23975006
## C 0.023 0.07875756 0.2799470 0.5000000 0.3032674 0.4566223 0.4183914 0.13285469
## D 0.029 0.12945588 0.4731845 0.6967326 0.5000000 0.7132410 0.6501386 0.22966818
## E 0.004 0.04867694 0.2517590 0.5433777 0.2867590 0.5000000 0.4440458 0.07893687
## F 0.017 0.07331631 0.3188664 0.5816086 0.3498614 0.5559542 0.5000000 0.12640645
## G 0.174 0.28954987 0.7602499 0.8671453 0.7703318 0.9210631 0.8735935 0.50000000
## H 0.165 0.24734659 0.5770127 0.7333055 0.5936804 0.7408523 0.6989733 0.38537815
##           H
## A 0.7526534
## B 0.4229873
## C 0.2666945
## D 0.4063196
## E 0.2591477
## F 0.3010267
## G 0.6146218
## H 0.5000000</code></pre>
</div>
<div id="q-5.3.c" class="section level4 hasAnchor" number="5.3.0.3">
<h4><span class="header-section-number">5.3.0.3</span> Q 5.3.c<a href="hierarchical-models.html#q-5.3.c" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<ul>
<li>5.3.c
Discussing the differences the intervals are much wider in the separate models for <span class="math inline">\(\theta_j\)</span> compared to the Bayesian model. This is because the Bayesian model borrows strenghts of associaton across other school information.</li>
</ul>
<p>Under separate model, the probability that A is best is approxmiately 0.521, whereas in Bayesian model it is 0.283. These inferences are more conservative in the Bayesian model because it incorporates uncertainty in the model. The Bayesian model assumes a uniform prior for <span class="math inline">\(\tau\)</span> which is the deviation/variability of the school coaching effectiveness, whereas in the separate model operates under the assumption that there is large variability of coaching effectiveness <span class="math inline">\(\tau = \infty\)</span>.</p>
<div class="sourceCode" id="cb334"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb334-1"><a href="hierarchical-models.html#cb334-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(allQ)</span></code></pre></div>
<pre><code>##          2.5%         25%        50%       75%    97.5%
## A  -1.6671674  16.8008160 28.4378866 38.292573 56.64421
## B -11.7881530   1.4666970  7.8338828 15.011281 25.71342
## C -32.9503177 -13.1854338 -2.8801841  8.302523 27.71221
## D -13.2036155   0.6344413  7.8860750 14.677863 28.52870
## E -18.8775183  -6.4175582 -0.3387703  5.609494 16.85795
## F -20.2917461  -6.9974197  0.9482539  8.851298 22.31686
## G  -0.9984314  11.3323360 17.5468144 24.429637 35.98980
## H -21.8486938  -0.4152265 12.2354066 23.914510 45.65002</code></pre>
<div class="sourceCode" id="cb336"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb336-1"><a href="hierarchical-models.html#cb336-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(allq)</span></code></pre></div>
<pre><code>##            2.5%      25%       50%       75%    97.5%
## t1q   0.4457383 7.326460 10.017273 16.091238 33.37148
## t2q  -3.9503168 4.831116  7.726473 10.619370 20.25554
## t3q -14.8226207 2.859082  6.858540  9.538431 18.57518
## t4q  -7.3115433 5.009563  7.783060 10.934833 21.04213
## t5q  -9.4629862 1.658382  6.024443  8.293584 14.69150
## t6q -10.7831533 2.029477  6.586762  8.797824 17.50866
## t7q   0.9487190 7.244206  9.623687 14.367122 25.85331
## t8q  -7.3113309 4.974897  7.888110 11.282060 27.24911</code></pre>
</div>
<div id="q-5.3-part-d" class="section level4 hasAnchor" number="5.3.0.4">
<h4><span class="header-section-number">5.3.0.4</span> Q 5.3 part d<a href="hierarchical-models.html#q-5.3-part-d" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<ul>
<li>5.3 d
setting <span class="math inline">\(\tau =0\)</span> creates <span class="math inline">\(\theta_j | \mu, \tau, y \sim N(\infty, 0)\)</span> because of the equation for <span class="math inline">\(\hat{\theta_j} = \infty/\infty\)</span> and <span class="math inline">\(V_j = 1/\infty =0\)</span>. the inferences for posterior for <span class="math inline">\(\mu | \tau, y\)</span> and <span class="math inline">\(\tau | y\)</span> are not degenerate. but for the parameters for <span class="math inline">\(\theta\)</span> these are degenerate. Setting <span class="math inline">\(\tau =0\)</span> means that the variance parameter goes to 0, which reduces all points to a point mass, and sets them equal (0 variability).</li>
</ul>
</div>
<div id="q4" class="section level4 unnumbered hasAnchor">
<h4>Q4<a href="hierarchical-models.html#q4" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<ul>
<li><ol style="list-style-type: lower-alpha">
<li>by definition of exchangability, other than the data there can be no information that can distinguish <span class="math inline">\(\theta_j\)</span>, and by having a distinct grouping of parameters in either N(1,1) or N(-1,1) this violates exchangability. However, the problem states that <em>we have not observed</em> which parameters come from any distribution. This is similar to the divorce problem, such that over the 8 mid-western states, we know that Utah and Nevada will have lower/higher divorce rates, however after observing 7 values, we do not have information about the 8th state that was not yet observed; this is an exchangeable process. However if we <em>had information</em> that the last state was Nevada or Utah, then this is <em>not</em> exchangeable. Since we have information that there will be a grouping, but currently did not observe the parameters, this is exchangeable.</li>
</ol></li>
</ul>
<p>Using equation 5.2 the prior is <span class="math inline">\(p(\theta) = \int \prod p(\theta_j | \phi) p(\phi)d\phi\)</span>
<span class="math display">\[\begin{equation}
p(\theta_1,...\theta_{2J}) \int \prod N(\theta_j | \mu, \sigma^2)p(\mu, \sigma^2)= \sum_p \prod_{i=1}^J N(\theta_j(p)| 1,1)\prod_{k=J+1}^{2J}N(\theta_{k(p)}| -1,1)\frac{1}{{2J\choose J}}
\end{equation}\]</span></p>
<p>Equation 5.14 we take the sum over the posterior under the prior. the probability <span class="math inline">\(p(\mu,\sigma^2)\)</span> we have 2J total groups and choose J.</p>
<p>-(b) given two distributions N(1,1) and N(-1,1) the estimates will have a negative covariance so we do not have an identically distributed mixture, we can assume independence, but for large values observed, these are likely to be originated from N(1,1), and for smaller , negative, values these are likely originated from N(-1,1). Thus these are not identically distributed.</p>
<p>-(c) for <span class="math inline">\(J\to \infty\)</span> the covariance between these two groups reduces to 0 as the number of groups approaches infinity. De-finitti’s theorem for infinite groups indicates that the distinction between exactly 2 groups disappears, and also assigning exactly half of the parameters to the correct half also disappears. So for infinite groupings, the distinction between groups is not possible and there is exchangability in the limit. However for finite groups we can not apply De-finitti’s theorem.</p>
</div>
<div id="q7" class="section level4 unnumbered hasAnchor">
<h4>Q7<a href="hierarchical-models.html#q7" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>-(a) we use Adam’s law to find the mean/variance of the prior y, s.t. <span class="math inline">\(y|\theta \sim Poi(\theta)\)</span>, and a gamma prior
<span class="math display">\[
\begin{aligned}
E[y] &amp;= E[E(y|\theta)] = E[\theta] \\
     &amp;= \alpha/\beta \\
V[y] &amp;= E[V(y|\theta)] + V[E(y|\theta)] = E[\theta] + V[\theta] = \alpha/\beta + \alpha/\beta^2 = \frac{\alpha(\beta+1)}{\beta^2}     
\end{aligned}
\]</span>
-(b) in the normal model we have marginally t= <span class="math inline">\(\frac{\sqrt{n}(\mu-\bar{y})}{s}\)</span> that is <span class="math inline">\(t_{n-1}\)</span>. Deriving the first 2 moments, where <span class="math inline">\(\mu \sim N(\bar{y},\sigma^2/n)\)</span>. where <span class="math inline">\(\sigma^2 | y \sim\)</span> Scaled-Inv-Chi2(n-1,<span class="math inline">\(s^2\)</span>).</p>
<p>Note we have to condition on y because the formula for <span class="math inline">\(t_{n-1}\)</span> includes <span class="math inline">\(\bar{y}\)</span>
<span class="math display">\[
\begin{aligned}
E[t_{n-1} | y] &amp;= E[E(\frac{\sqrt{n}(\mu-\bar{y})}{s}) |y] = 0 \\
V[t_{n-1} | y] &amp;= E[V(t|\sigma^2,y) |y] +V[ E(t|y)] \\
&amp;= E[\frac{n}{s^2}V((\mu-\bar{y})|\sigma^2,y)|y] +0 \\
&amp;= E[\frac{n\sigma^2}{n*s^2}] = \frac{s^2(n-1)}{s^2(n-3)}=(n-1)/(n-3) ; n &gt;3
\end{aligned}
\]</span></p>
</div>
<div id="q10" class="section level4 unnumbered hasAnchor">
<h4>Q10<a href="hierarchical-models.html#q10" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>-(a) if the hyperprior <span class="math inline">\(p(\mu,\tau)\propto \tau^{-1}\)</span> show that the posterior is improper
the posterior is written as <span class="math inline">\(p(\theta,\mu,\tau | y) = p(\theta,\mu | \tau, y)p(\tau|y)\)</span>. This is proper if both terms are proper, and it is improper if at least 1 term is improper.
we show that <span class="math inline">\(p(\tau | y)\)</span> is improper for <span class="math inline">\(p(\tau)\propto \tau^{-1}\)</span>. Using equation 5.21
<span class="math display">\[
\begin{aligned}
p(\tau|y) \propto \int p(\tau)V_{\mu}^{-1/2}\prod_{j=1}^J(\sigma_j^2+\tau^2)^{-1/2}exp(\frac{-(\bar{y_{.j}}-\hat{\mu})^2)}{2(\sigma_j^2+\tau^2)})d\tau \\
\int_{0}^{\infty} \frac{1}{\tau}V_{\mu}^{-1/2}\prod_{j=1}^J(\sigma_j^2+\tau^2)^{-1/2}exp(\frac{-(\bar{y_{.j}-\hat{\mu})^2})}{2(\sigma_j^2+\tau^2)})d\tau \\
\end{aligned}
\]</span>
so this is undefined for <span class="math inline">\(\tau=0\)</span> and hence the term <span class="math inline">\(p(\tau|y\)</span>) is undefined and causes the posterior to be undefined.</p>
<p>-(b) for <span class="math inline">\(p(\mu,\tau)\propto 1\)</span> equation 5.16 has 2 proper distributions that are in the normal family distribution and are well-defined. <span class="math inline">\(N(\theta_j | \mu,\tau^2)\)</span> and <span class="math inline">\(N(\bar{y_{.j}} | \theta_j, \sigma_j^2)\)</span> so these are proper distributions.</p>
<p>Another way to see this is to take the limits of equation 5.21 where <span class="math inline">\(p(\tau)\propto 1\)</span> As the limit goes to 0 the term is well defined.
<span class="math display">\[
\begin{aligned}
&amp; \lim_{\tau \to 0} p(\tau)V_{\mu}^{-1/2}\prod_{j=1}^J(\sigma_j^2+\tau^2)^{-1/2}exp(\frac{-(\bar{y_{.j}}-\hat{\mu})^2)}{2(\sigma_j^2+\tau^2)}) = \\
&amp; \frac{1}{\sum \frac{1}{\sigma_j^2}}^{1/2}\prod (\sigma_j^2)^{-1/2}exp(\frac{-(\bar{y_{.j}}-\hat{\mu})^2)}{2\sigma_j^2}) \\
\end{aligned}
\]</span>
As the limit <span class="math inline">\(\tau \to \infty\)</span> we the exponential term goes to 0 because <span class="math inline">\(\tau\)</span> is in the denominator, so the entire term will go to 0. So the posterior is proper because the limits are defined.</p>
<p>-(c) if i had data from J=2 schools only, i would test for between variance and within variance to see is MS justify pooling the estimates for both schools, or require separate models for each. if within each school there were enough students to justify modeling school-specific parameters, I would use equation 5.16 and model the posterior distribution.<br />
Another option is to model each school independently as separate models with known variance and i would use non-informative priors.</p>
</div>
<div id="q11" class="section level4 unnumbered hasAnchor">
<h4>Q11<a href="hierarchical-models.html#q11" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>For non conjugate models suppose that in the rat tumor example we had <span class="math inline">\(logit(\theta_j)\sim N(\mu,\tau^2)\)</span> for j=1,…,J and assume a non-informative prior for the hyperparameters.
-(a) the joint posterior can be written as
<span class="math display">\[\begin{equation}
   p(\theta,\mu,\tau|y ) = p(\theta,\mu,\tau)p(y|\theta,\mu,\tau) = p(\theta|\mu,\tau)p(\mu,\tau)p(y|\theta,\mu,\tau)
   \end{equation}\]</span></p>
<p>Note that <span class="math inline">\(p(\theta,\mu,\tau)\)</span> is in terms of <span class="math inline">\(\theta\)</span> and not on the logit scale, so we need the jacobian for change of variables.</p>
<p><span class="math display">\[
\begin{aligned}
p(\theta|\mu,\tau)p(\mu,\tau)p(y|\theta,\mu,\tau) = p(\mu,\tau)\prod_j \frac{1}{\sqrt{2\pi}\tau}exp(\frac{-1}{2\tau^2}(logit(\theta_j -\mu)^2))\prod_j(\theta_j)^{y_{i}}(1-\theta_j)^{n_i-y_i} |dlogit(\theta)/d\theta| \\
p(\theta|\mu,\tau)p(\mu,\tau)p(y|\theta,\mu,\tau) = p(\mu,\tau)\prod_j \frac{1}{\sqrt{2\pi}\tau}exp(\frac{-1}{2\tau^2}(logit(\theta_j -\mu)^2))\prod_j(\theta_j)^{y_{i}}(1-\theta_j)^{n_i-y_i}|\frac{1}{\theta(1-\theta)}|
\end{aligned}
\]</span>
-(b) we can not integrate this equation fully because it is not in a known family. Although we have separate factors in the equation, we can not analytically derive the integral in closed form.
-(c) Using equation 5.5 <span class="math inline">\(p(\mu,\tau |y) = \frac{p(\theta,\mu,\tau | y)}{p(\theta| \mu,\tau, y)}\)</span> we can not integrate the denominator <span class="math inline">\(p(\theta|mu,\tau,y)\)</span> in closed form as a function of <span class="math inline">\(\mu,\tau\)</span> which doesn’t have a closed form solution.</p>
</div>
<div id="q12" class="section level4 unnumbered hasAnchor">
<h4>Q12<a href="hierarchical-models.html#q12" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>To find the conditional expection we use equation 5.20 and 5.17 from the text</p>
<p><span class="math display">\[
\begin{aligned}
E[\theta_j | \tau, y ] &amp;= E[ E(\theta_j| \mu, \tau, y) | \tau,y] \\
&amp; = E[ \hat{\theta_j} | \tau, y] =\frac{ 1/\sigma_j^2 \bar{y_{.j}}+1/\tau^2 E[\mu]}{1/\sigma_j^2+1/\tau^2} \\
&amp; = \frac{ 1/\sigma_j^2 \bar{y_{.j}}+1/\tau^2 \hat{\mu}}{1/\sigma_j^2+1/\tau^2} \\
\text{where  } \hat{\mu} = \frac{\sum_j \frac{1}{\sigma_j^2+\tau^2}\bar{y_{.j}}}{\sum_j \frac{1}{\sigma_j^2+\tau^2}}
\end{aligned}
\]</span></p>
<div class="sourceCode" id="cb338"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb338-1"><a href="hierarchical-models.html#cb338-1" aria-hidden="true" tabindex="-1"></a>school<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="at">school=</span>LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>],</span>
<span id="cb338-2"><a href="hierarchical-models.html#cb338-2" aria-hidden="true" tabindex="-1"></a>                   <span class="at">yj =</span><span class="fu">c</span>(<span class="dv">28</span>,<span class="dv">8</span>,<span class="sc">-</span><span class="dv">3</span>,<span class="dv">7</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">18</span>,<span class="dv">12</span>),</span>
<span id="cb338-3"><a href="hierarchical-models.html#cb338-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">sigmaj =</span> <span class="fu">c</span>(<span class="dv">15</span>,<span class="dv">10</span>,<span class="dv">16</span>,<span class="dv">11</span>,<span class="dv">9</span>,<span class="dv">11</span>,<span class="dv">10</span>,<span class="dv">18</span>))</span>
<span id="cb338-4"><a href="hierarchical-models.html#cb338-4" aria-hidden="true" tabindex="-1"></a>school<span class="sc">$</span>sigma2j<span class="ot">&lt;-</span>school<span class="sc">$</span>sigmaj<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb338-5"><a href="hierarchical-models.html#cb338-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-6"><a href="hierarchical-models.html#cb338-6" aria-hidden="true" tabindex="-1"></a><span class="do">## conditional expectation</span></span>
<span id="cb338-7"><a href="hierarchical-models.html#cb338-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-8"><a href="hierarchical-models.html#cb338-8" aria-hidden="true" tabindex="-1"></a>mu_hat<span class="ot">&lt;-</span><span class="cf">function</span>(allsigma2j,tau2,allybarj){</span>
<span id="cb338-9"><a href="hierarchical-models.html#cb338-9" aria-hidden="true" tabindex="-1"></a>   numer<span class="ot">&lt;-</span><span class="fu">sum</span>( (<span class="dv">1</span><span class="sc">/</span>(allsigma2j<span class="sc">+</span>tau2))<span class="sc">*</span>allybarj)</span>
<span id="cb338-10"><a href="hierarchical-models.html#cb338-10" aria-hidden="true" tabindex="-1"></a>   denom<span class="ot">&lt;-</span><span class="fu">sum</span>(<span class="dv">1</span><span class="sc">/</span>(allsigma2j<span class="sc">+</span>tau2))</span>
<span id="cb338-11"><a href="hierarchical-models.html#cb338-11" aria-hidden="true" tabindex="-1"></a>   muhat<span class="ot">=</span> numer<span class="sc">/</span>denom</span>
<span id="cb338-12"><a href="hierarchical-models.html#cb338-12" aria-hidden="true" tabindex="-1"></a>   <span class="fu">return</span>(muhat)</span>
<span id="cb338-13"><a href="hierarchical-models.html#cb338-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb338-14"><a href="hierarchical-models.html#cb338-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-15"><a href="hierarchical-models.html#cb338-15" aria-hidden="true" tabindex="-1"></a>conditionalExpectation<span class="ot">&lt;-</span><span class="cf">function</span>(sigma2j,ybarj,tau2,allsigma2j,allybarj){</span>
<span id="cb338-16"><a href="hierarchical-models.html#cb338-16" aria-hidden="true" tabindex="-1"></a>  muhat<span class="ot">&lt;-</span><span class="fu">mu_hat</span>(allsigma2j, tau2,allybarj)</span>
<span id="cb338-17"><a href="hierarchical-models.html#cb338-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb338-18"><a href="hierarchical-models.html#cb338-18" aria-hidden="true" tabindex="-1"></a>  a<span class="ot">&lt;-</span>((<span class="dv">1</span><span class="sc">/</span>sigma2j)<span class="sc">*</span>ybarj)<span class="sc">/</span>(<span class="dv">1</span><span class="sc">/</span>sigma2j <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>tau2)</span>
<span id="cb338-19"><a href="hierarchical-models.html#cb338-19" aria-hidden="true" tabindex="-1"></a>  b<span class="ot">&lt;-</span> ((<span class="dv">1</span><span class="sc">/</span>tau2)<span class="sc">*</span>muhat)<span class="sc">/</span>(<span class="dv">1</span><span class="sc">/</span>sigma2j <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>tau2)</span>
<span id="cb338-20"><a href="hierarchical-models.html#cb338-20" aria-hidden="true" tabindex="-1"></a>  cond.mean<span class="ot">&lt;-</span>a<span class="sc">+</span>b</span>
<span id="cb338-21"><a href="hierarchical-models.html#cb338-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(cond.mean)</span>
<span id="cb338-22"><a href="hierarchical-models.html#cb338-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb338-23"><a href="hierarchical-models.html#cb338-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-24"><a href="hierarchical-models.html#cb338-24" aria-hidden="true" tabindex="-1"></a>tau_seq <span class="ot">=</span> <span class="fu">seq</span>(<span class="fl">0.1</span>,<span class="dv">30</span>,<span class="at">by=</span><span class="fl">0.01</span>)</span>
<span id="cb338-25"><a href="hierarchical-models.html#cb338-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-26"><a href="hierarchical-models.html#cb338-26" aria-hidden="true" tabindex="-1"></a>  allmeans<span class="ot">&lt;-</span><span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow=</span><span class="fu">length</span>(tau_seq),<span class="at">ncol=</span><span class="fu">nrow</span>(school))</span>
<span id="cb338-27"><a href="hierarchical-models.html#cb338-27" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(school)){  </span>
<span id="cb338-28"><a href="hierarchical-models.html#cb338-28" aria-hidden="true" tabindex="-1"></a> aa<span class="ot">&lt;-</span><span class="fu">sapply</span>(tau_seq,<span class="cf">function</span>(x) <span class="fu">conditionalExpectation</span>(school<span class="sc">$</span>sigma2j[i],school<span class="sc">$</span>yj[i],<span class="at">tau2=</span>x<span class="sc">^</span><span class="dv">2</span>,school<span class="sc">$</span>sigma2j,school<span class="sc">$</span>yj))</span>
<span id="cb338-29"><a href="hierarchical-models.html#cb338-29" aria-hidden="true" tabindex="-1"></a> allmeans[,i]<span class="ot">&lt;-</span>aa</span>
<span id="cb338-30"><a href="hierarchical-models.html#cb338-30" aria-hidden="true" tabindex="-1"></a>} </span>
<span id="cb338-31"><a href="hierarchical-models.html#cb338-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb338-32"><a href="hierarchical-models.html#cb338-32" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(tau_seq,allmeans[,<span class="dv">1</span>],<span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span>,<span class="dv">30</span>),<span class="at">ylab=</span><span class="st">&#39;Estimated Treatment Effects&#39;</span>, <span class="at">xlab=</span><span class="st">&#39;tau&#39;</span>)</span>
<span id="cb338-33"><a href="hierarchical-models.html#cb338-33" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(tau_seq,allmeans[,<span class="dv">2</span>],<span class="at">col=</span><span class="st">&#39;green&#39;</span>)</span>
<span id="cb338-34"><a href="hierarchical-models.html#cb338-34" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(tau_seq,allmeans[,<span class="dv">3</span>],<span class="at">col=</span><span class="st">&#39;red&#39;</span>)</span>
<span id="cb338-35"><a href="hierarchical-models.html#cb338-35" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(tau_seq,allmeans[,<span class="dv">4</span>],<span class="at">col=</span><span class="st">&#39;blue&#39;</span>)</span>
<span id="cb338-36"><a href="hierarchical-models.html#cb338-36" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(tau_seq,allmeans[,<span class="dv">5</span>],<span class="at">col=</span><span class="st">&#39;yellow&#39;</span>)</span>
<span id="cb338-37"><a href="hierarchical-models.html#cb338-37" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(tau_seq,allmeans[,<span class="dv">6</span>],<span class="at">col=</span><span class="st">&#39;purple&#39;</span>)</span>
<span id="cb338-38"><a href="hierarchical-models.html#cb338-38" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(tau_seq,allmeans[,<span class="dv">7</span>],<span class="at">col=</span><span class="st">&#39;orange&#39;</span>)</span>
<span id="cb338-39"><a href="hierarchical-models.html#cb338-39" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(tau_seq,allmeans[,<span class="dv">8</span>],<span class="at">col=</span><span class="st">&#39;brown&#39;</span>)</span>
<span id="cb338-40"><a href="hierarchical-models.html#cb338-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-41"><a href="hierarchical-models.html#cb338-41" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="dv">0</span>, <span class="dv">25</span>, </span>
<span id="cb338-42"><a href="hierarchical-models.html#cb338-42" aria-hidden="true" tabindex="-1"></a>       <span class="at">legend=</span><span class="fu">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>,<span class="st">&quot;C&quot;</span>,<span class="st">&quot;D&quot;</span>,<span class="st">&quot;E&quot;</span>,<span class="st">&quot;F&quot;</span>,<span class="st">&quot;G&quot;</span>,<span class="st">&quot;H&quot;</span>),</span>
<span id="cb338-43"><a href="hierarchical-models.html#cb338-43" aria-hidden="true" tabindex="-1"></a>       <span class="at">col=</span><span class="fu">c</span>(<span class="st">&quot;black&quot;</span>, <span class="st">&quot;green&quot;</span>,<span class="st">&quot;red&quot;</span>,<span class="st">&quot;blue&quot;</span>,<span class="st">&quot;yellow&quot;</span>,<span class="st">&quot;purple&quot;</span>,<span class="st">&quot;orange&quot;</span>,<span class="st">&quot;brown&quot;</span>), <span class="at">lty=</span><span class="dv">1</span>, <span class="at">cex=</span><span class="fl">0.8</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-71-1.png" width="672" />
For the <span class="math inline">\(V(\theta_j | \tau,y) = E[V(\theta_j | \mu,\tau,y)|\tau,y] + V[E(\theta_j | \mu,\tau,y)|\tau,y)]\)</span> Using the equations for <span class="math inline">\(V_j , V_\mu\)</span> from section 5 we derived the conditional variance.</p>
<p><span class="math display">\[
\begin{aligned}
E[V(\theta_j | \mu,\tau,y)|\tau,y] + V[E(\theta_j | \mu,\tau,y)|\tau,y)] &amp;= E[V_j | \tau, y] +V[\hat{\theta_j}| \tau, y] \\
&amp;= V_j +Vj^2(1/\tau^2)^2V_\mu
\end{aligned}
\]</span></p>
<div class="sourceCode" id="cb339"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb339-1"><a href="hierarchical-models.html#cb339-1" aria-hidden="true" tabindex="-1"></a> V_mu<span class="ot">&lt;-</span><span class="cf">function</span>(allsigma2j,tau2){</span>
<span id="cb339-2"><a href="hierarchical-models.html#cb339-2" aria-hidden="true" tabindex="-1"></a>   vinv<span class="ot">&lt;-</span><span class="fu">sum</span>( <span class="dv">1</span><span class="sc">/</span>(allsigma2j<span class="sc">+</span>tau2))</span>
<span id="cb339-3"><a href="hierarchical-models.html#cb339-3" aria-hidden="true" tabindex="-1"></a>   vmu<span class="ot">=</span><span class="dv">1</span><span class="sc">/</span>vinv</span>
<span id="cb339-4"><a href="hierarchical-models.html#cb339-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">return</span>(vmu)</span>
<span id="cb339-5"><a href="hierarchical-models.html#cb339-5" aria-hidden="true" tabindex="-1"></a> }</span>
<span id="cb339-6"><a href="hierarchical-models.html#cb339-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb339-7"><a href="hierarchical-models.html#cb339-7" aria-hidden="true" tabindex="-1"></a>conditionalVariance<span class="ot">&lt;-</span><span class="cf">function</span>(sigma2j, tau2,allsigma2j){</span>
<span id="cb339-8"><a href="hierarchical-models.html#cb339-8" aria-hidden="true" tabindex="-1"></a>  vmu<span class="ot">&lt;-</span><span class="fu">V_mu</span>(allsigma2j,tau2)</span>
<span id="cb339-9"><a href="hierarchical-models.html#cb339-9" aria-hidden="true" tabindex="-1"></a>  Vj <span class="ot">=</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span><span class="sc">/</span>sigma2j<span class="sc">+</span><span class="dv">1</span><span class="sc">/</span>tau2) </span>
<span id="cb339-10"><a href="hierarchical-models.html#cb339-10" aria-hidden="true" tabindex="-1"></a>  cond.var<span class="ot">&lt;-</span>Vj<span class="sc">+</span>Vj<span class="sc">^</span><span class="dv">2</span><span class="sc">*</span>(<span class="dv">1</span><span class="sc">/</span>tau2)<span class="sc">^</span><span class="dv">2</span><span class="sc">*</span>vmu</span>
<span id="cb339-11"><a href="hierarchical-models.html#cb339-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(cond.var)</span>
<span id="cb339-12"><a href="hierarchical-models.html#cb339-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb339-13"><a href="hierarchical-models.html#cb339-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb339-14"><a href="hierarchical-models.html#cb339-14" aria-hidden="true" tabindex="-1"></a>tau_seq <span class="ot">=</span> <span class="fu">seq</span>(<span class="fl">0.1</span>,<span class="dv">30</span>,<span class="at">by=</span><span class="fl">0.01</span>)</span>
<span id="cb339-15"><a href="hierarchical-models.html#cb339-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb339-16"><a href="hierarchical-models.html#cb339-16" aria-hidden="true" tabindex="-1"></a>  allsd<span class="ot">&lt;-</span><span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow=</span><span class="fu">length</span>(tau_seq),<span class="at">ncol=</span><span class="fu">nrow</span>(school))</span>
<span id="cb339-17"><a href="hierarchical-models.html#cb339-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(school)){  </span>
<span id="cb339-18"><a href="hierarchical-models.html#cb339-18" aria-hidden="true" tabindex="-1"></a> aa<span class="ot">&lt;-</span><span class="fu">sapply</span>(tau_seq,<span class="cf">function</span>(x) <span class="fu">conditionalVariance</span>(school<span class="sc">$</span>sigma2j[i],<span class="at">tau2=</span>x<span class="sc">^</span><span class="dv">2</span>,school<span class="sc">$</span>sigma2j))</span>
<span id="cb339-19"><a href="hierarchical-models.html#cb339-19" aria-hidden="true" tabindex="-1"></a> allsd[,i]<span class="ot">&lt;-</span><span class="fu">sqrt</span>(aa)</span>
<span id="cb339-20"><a href="hierarchical-models.html#cb339-20" aria-hidden="true" tabindex="-1"></a>} </span>
<span id="cb339-21"><a href="hierarchical-models.html#cb339-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb339-22"><a href="hierarchical-models.html#cb339-22" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(tau_seq,allsd[,<span class="dv">1</span>],<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">20</span>),<span class="at">ylab=</span><span class="st">&#39;Posterior Standard Deviation&#39;</span>, <span class="at">xlab=</span><span class="st">&#39;tau&#39;</span>)</span>
<span id="cb339-23"><a href="hierarchical-models.html#cb339-23" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(tau_seq,allsd[,<span class="dv">2</span>],<span class="at">col=</span><span class="st">&#39;green&#39;</span>)</span>
<span id="cb339-24"><a href="hierarchical-models.html#cb339-24" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(tau_seq,allsd[,<span class="dv">3</span>],<span class="at">col=</span><span class="st">&#39;red&#39;</span>)</span>
<span id="cb339-25"><a href="hierarchical-models.html#cb339-25" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(tau_seq,allsd[,<span class="dv">4</span>],<span class="at">col=</span><span class="st">&#39;blue&#39;</span>)</span>
<span id="cb339-26"><a href="hierarchical-models.html#cb339-26" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(tau_seq,allsd[,<span class="dv">5</span>],<span class="at">col=</span><span class="st">&#39;yellow&#39;</span>)</span>
<span id="cb339-27"><a href="hierarchical-models.html#cb339-27" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(tau_seq,allsd[,<span class="dv">6</span>],<span class="at">col=</span><span class="st">&#39;purple&#39;</span>)</span>
<span id="cb339-28"><a href="hierarchical-models.html#cb339-28" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(tau_seq,allsd[,<span class="dv">7</span>],<span class="at">col=</span><span class="st">&#39;orange&#39;</span>)</span>
<span id="cb339-29"><a href="hierarchical-models.html#cb339-29" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(tau_seq,allsd[,<span class="dv">8</span>],<span class="at">col=</span><span class="st">&#39;brown&#39;</span>)</span>
<span id="cb339-30"><a href="hierarchical-models.html#cb339-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb339-31"><a href="hierarchical-models.html#cb339-31" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="dv">0</span>, <span class="dv">15</span>, </span>
<span id="cb339-32"><a href="hierarchical-models.html#cb339-32" aria-hidden="true" tabindex="-1"></a>       <span class="at">legend=</span><span class="fu">c</span>(<span class="st">&quot;A&quot;</span>, <span class="st">&quot;B&quot;</span>,<span class="st">&quot;C&quot;</span>,<span class="st">&quot;D&quot;</span>,<span class="st">&quot;E&quot;</span>,<span class="st">&quot;F&quot;</span>,<span class="st">&quot;G&quot;</span>,<span class="st">&quot;H&quot;</span>),</span>
<span id="cb339-33"><a href="hierarchical-models.html#cb339-33" aria-hidden="true" tabindex="-1"></a>       <span class="at">col=</span><span class="fu">c</span>(<span class="st">&quot;black&quot;</span>, <span class="st">&quot;green&quot;</span>,<span class="st">&quot;red&quot;</span>,<span class="st">&quot;blue&quot;</span>,<span class="st">&quot;yellow&quot;</span>,<span class="st">&quot;purple&quot;</span>,<span class="st">&quot;orange&quot;</span>,<span class="st">&quot;brown&quot;</span>), <span class="at">lty=</span><span class="dv">1</span>, <span class="at">cex=</span><span class="fl">0.8</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-72-1.png" width="672" /></p>

</div>
</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="asymptotics-and-connections-to-non-bayesian-approaches.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="sharing-your-book.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/USERNAME/REPO/edit/BRANCH/05-Hierarchical-models.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
